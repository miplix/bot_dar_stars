"""
–ú–æ–¥—É–ª—å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ò–ò (DeepSeek API)
–ê–Ω–∞–ª–∏–∑ –¥–∞—Ä–æ–≤ –∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç—Ä–∞–∫—Ç–æ–≤–æ–∫
"""
import aiohttp
from config import Config
from database import Database
from gifts_knowledge import get_gift_info, get_gifts_by_kun, format_gift_description, format_multiple_gifts

class AIHandler:
    """–ö–ª–∞—Å—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ò–ò"""
    
    def __init__(self):
        self.api_key = Config.DEEPSEEK_API_KEY
        self.api_url = Config.DEEPSEEK_API_URL
        self.db = Database()
        
        # –õ–æ–≥–∏—Ä—É–µ–º —Å—Ç–∞—Ç—É—Å API –∫–ª—é—á–∞ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
        if self.api_key:
            print(f"‚úÖ AIHandler –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω —Å API –∫–ª—é—á–æ–º (–¥–ª–∏–Ω–∞: {len(self.api_key)} —Å–∏–º–≤–æ–ª–æ–≤)")
        else:
            print("‚ö†Ô∏è AIHandler –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω –ë–ï–ó API –∫–ª—é—á–∞ - –±—É–¥—É—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –±–∞–∑–æ–≤—ã–µ –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏–∏")
    
    async def get_gift_interpretation(self, gift_data: dict, user_context: str = "") -> str:
        """
        –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç—Ä–∞–∫—Ç–æ–≤–∫–∏ –¥–∞—Ä–∞ –æ—Ç –ò–ò –Ω–∞ –æ—Å–Ω–æ–≤–µ –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π
        
        Args:
            gift_data: –î–∞–Ω–Ω—ã–µ –æ —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–Ω—ã—Ö –¥–∞—Ä–∞—Ö (—Å–æ–¥–µ—Ä–∂–∏—Ç gift_code –≤ —Ñ–æ—Ä–º–∞—Ç–µ "–º–∞-–∂–∏-–∫—É–Ω")
            user_context: –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
        
        Returns:
            –¢—Ä–∞–∫—Ç–æ–≤–∫–∞ –æ—Ç –ò–ò
        """
        if not self.api_key:
            return self._get_basic_interpretation(gift_data)
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º –∑–∞–ø—Ä–æ—Å –∫ –ò–ò
        prompt = self._build_prompt(gift_data, user_context)
        
        try:
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –∫ DeepSeek API
            async with aiohttp.ClientSession() as session:
                headers = {
                    "Authorization": f"Bearer {self.api_key}",
                    "Content-Type": "application/json"
                }
                
                data = {
                    "model": "deepseek-chat",
                    "messages": [
                        {
                            "role": "system",
                            "content": """–¢—ã —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –¥—Ä–µ–≤–Ω–µ—Å–ª–∞–≤—è–Ω—Å–∫–æ–π —Å–∏—Å—Ç–µ–º–µ –¥–∞—Ä–æ–≤ —Ä–æ–∂–¥–µ–Ω–∏—è –ú–∞-–ñ–∏-–ö—É–Ω. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ - –¥–∞–≤–∞—Ç—å –≥–ª—É–±–æ–∫–∏–µ, —Ç–æ—á–Ω—ã–µ –∏ –ª–∞–∫–æ–Ω–∏—á–Ω—ã–µ —Ç—Ä–∞–∫—Ç–æ–≤–∫–∏ –¥–∞—Ä–æ–≤ —á–µ–ª–æ–≤–µ–∫–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–∞—Å—á–µ—Ç–æ–≤ –ø–æ –¥–∞—Ç–µ —Ä–æ–∂–¥–µ–Ω–∏—è.

–í–ê–ñ–ù–û! –¢–≤–æ–π –æ—Ç–≤–µ—Ç –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ Telegram, –ø–æ—ç—Ç–æ–º—É –∏—Å–ø–æ–ª—å–∑—É–π –¢–û–õ–¨–ö–û Telegram-—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:

‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è Telegram:
‚Ä¢ *–∂–∏—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç* (–æ–¥–Ω–∞ –∑–≤–µ–∑–¥–æ—á–∫–∞ —Å –∫–∞–∂–¥–æ–π —Å—Ç–æ—Ä–æ–Ω—ã)
‚Ä¢ _–∫—É—Ä—Å–∏–≤_ (–æ–¥–Ω–æ –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏–µ)
‚Ä¢ `–∫–æ–¥ –∏–ª–∏ —Ü–∏—Ç–∞—Ç–∞` (–æ–±—Ä–∞—Ç–Ω—ã–µ –∫–∞–≤—ã—á–∫–∏)
‚Ä¢ –ò—Å–ø–æ–ª—å–∑—É–π —ç–º–æ–¥–∑–∏ –¥–ª—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã: üéÅ üí´ ‚ú® üîÆ üí° ‚ö° üåü
‚Ä¢ –†–∞–∑–¥–µ–ª—è–π —Ä–∞–∑–¥–µ–ª—ã –ø—É—Å—Ç—ã–º–∏ —Å—Ç—Ä–æ–∫–∞–º–∏ –¥–ª—è —á–∏—Ç–∞–µ–º–æ—Å—Ç–∏

‚ùå –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π:
‚Ä¢ ** (–¥–≤–æ–π–Ω—ã–µ –∑–≤–µ–∑–¥–æ—á–∫–∏)
‚Ä¢ ### –∏–ª–∏ # (–∑–∞–≥–æ–ª–æ–≤–∫–∏ markdown)
‚Ä¢ –î—Ä—É–≥–∏–µ markdown-—Å–∏–º–≤–æ–ª—ã, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ —Ä–∞–±–æ—Ç–∞—é—Ç –≤ Telegram

–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ—Ç–≤–µ—Ç–∞:
1. –ö—Ä–∞—Ç–∫–æ–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ —Å —ç–º–æ–¥–∑–∏
2. –ó–Ω–∞—á–µ–Ω–∏–µ –¥–∞—Ä–∞ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º *–∂–∏—Ä–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞*
3. –°–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã (—Å —ç–º–æ–¥–∑–∏)
4. –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ (—Å —ç–º–æ–¥–∑–∏)
5. –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–û—Ç–≤–µ—á–∞–π —Ç–æ–ª—å–∫–æ –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ. –ë—É–¥—å –≥–ª—É–±–æ–∫–∏–º, –Ω–æ –ª–∞–∫–æ–Ω–∏—á–Ω—ã–º."""
                        },
                        {
                            "role": "user",
                            "content": prompt
                        }
                    ],
                    "temperature": 0.7,
                    "max_tokens": 2000
                }
                
                async with session.post(
                    f"{self.api_url}/chat/completions",
                    headers=headers,
                    json=data
                ) as response:
                    if response.status == 200:
                        result = await response.json()
                        return result['choices'][0]['message']['content']
                    else:
                        return self._get_basic_interpretation(gift_data)
        
        except Exception as e:
            print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ –ò–ò: {e}")
            return self._get_basic_interpretation(gift_data)
    
    def _build_prompt(self, gift_data: dict, user_context: str) -> str:
        """–ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –ø—Ä–æ–º–ø—Ç–∞ –¥–ª—è –ò–ò"""
        gift_code = gift_data.get('gift_code', '')
        birth_date = gift_data.get('birth_date', '')
        ma = gift_data.get('ma', 0)
        ji = gift_data.get('ji', 0)
        kun = gift_data.get('kun', 0)
        
        # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –¥–∞—Ä–µ –∏–∑ –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π
        gift_info = get_gift_info(gift_code)
        
        prompt = f"""–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –¥–∞—Ä —á–µ–ª–æ–≤–µ–∫–∞ –ø–æ –¥–∞—Ç–µ —Ä–æ–∂–¥–µ–Ω–∏—è {birth_date}:

üî¢ –†–∞—Å—á–µ—Ç –ø–æ —Å–∏—Å—Ç–µ–º–µ –ú–∞-–ñ–∏-–ö—É–Ω:
‚Ä¢ –ú–∞ (–¥–µ–Ω—å+–º–µ—Å—è—Ü): {ma}
‚Ä¢ –ñ–∏ (–≥–æ–¥): {ji}  
‚Ä¢ –ö—É–Ω (–º–∞+–∂–∏): {kun}
‚Ä¢ –ö–æ–¥ –¥–∞—Ä–∞: {gift_code}

"""
        
        # –ï—Å–ª–∏ –¥–∞—Ä –Ω–∞–π–¥–µ–Ω –≤ –±–∞–∑–µ, –¥–æ–±–∞–≤–ª—è–µ–º –µ–≥–æ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
        if gift_info:
            prompt += f"""üìö –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –¥–∞—Ä–µ –∏–∑ –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π:
‚Ä¢ –ù–∞–∑–≤–∞–Ω–∏–µ: {gift_info.get('name', '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ')}
‚Ä¢ –û–ø–∏—Å–∞–Ω–∏–µ: {gift_info.get('description', '–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è')}

"""
        else:
            # –ï—Å–ª–∏ —Ç–æ—á–Ω–æ–≥–æ –¥–∞—Ä–∞ –Ω–µ—Ç, –∏—â–µ–º –¥–∞—Ä—ã —Å —Ç–∞–∫–∏–º –∂–µ –∫—É–Ω
            kun_gifts = get_gifts_by_kun(kun)
            if kun_gifts:
                prompt += f"üìö –¢–æ—á–Ω–æ–≥–æ –¥–∞—Ä–∞ {gift_code} –Ω–µ –Ω–∞–π–¥–µ–Ω–æ, –Ω–æ –µ—Å—Ç—å –¥–∞—Ä—ã —Å —Ç–∞–∫–∏–º –∂–µ –ö—É–Ω ({kun}):\n\n"
                for kg in kun_gifts[:3]:  # –ë–µ—Ä–µ–º –ø–µ—Ä–≤—ã–µ 3 –¥–∞—Ä–∞
                    prompt += f"‚Ä¢ {kg.get('name', '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ')} ({kg.get('code', '')})\n"
                    prompt += f"  {kg.get('description', '')[:100]}...\n\n"
        
        if user_context:
            prompt += f"–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç: {user_context}\n\n"
        
        prompt += """–ù–∞ –æ—Å–Ω–æ–≤–µ —ç—Ç–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –¥–∞–π –ø–æ–ª–Ω—É—é —Ç—Ä–∞–∫—Ç–æ–≤–∫—É –¥–∞—Ä–∞:
1. –ó–Ω–∞—á–µ–Ω–∏–µ –¥–∞—Ä–∞ –∏ –µ–≥–æ —ç–Ω–µ—Ä–≥–µ—Ç–∏–∫–∞
2. –°–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã –∏ —Ç–∞–ª–∞–Ω—Ç—ã
3. –ñ–∏–∑–Ω–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏ –∏ –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ
4. –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —Ä–∞—Å–∫—Ä—ã—Ç–∏—é –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª–∞

–û—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≥–ª—É–±–æ–∫–∏–º, —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –∏ –ø—Ä–∞–∫—Ç–∏—á–Ω—ã–º."""
        
        return prompt
    
    def _get_basic_interpretation(self, gift_data: dict) -> str:
        """–ë–∞–∑–æ–≤–∞—è —Ç—Ä–∞–∫—Ç–æ–≤–∫–∞ –±–µ–∑ –ò–ò (—Ä–µ–∑–µ—Ä–≤–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç) - —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è Telegram"""
        birth_date = gift_data.get('birth_date', '')
        gift_code = gift_data.get('gift_code', '')
        ma = gift_data.get('ma', 0)
        ji = gift_data.get('ji', 0)
        kun = gift_data.get('kun', 0)
        
        result = f"üîÆ *–ê–Ω–∞–ª–∏–∑ –¥–∞—Ä–∞ –ø–æ –¥–∞—Ç–µ —Ä–æ–∂–¥–µ–Ω–∏—è {birth_date}*\n\n"
        
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–∞—Å—á–µ—Ç—ã
        if 'calculation_details' in gift_data:
            result += "üî¢ *–†–∞—Å—á–µ—Ç:*\n"
            result += f"‚Ä¢ {gift_data['calculation_details']['ma']}\n"
            result += f"‚Ä¢ {gift_data['calculation_details']['ji']}\n"
            result += f"‚Ä¢ {gift_data['calculation_details']['kun']}\n\n"
        
        result += f"üéÅ *–í–∞—à –¥–∞—Ä: {gift_code}*\n\n"
        
        # –ü—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ –¥–∞—Ä –≤ –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π
        gift_info = get_gift_info(gift_code)
        
        if gift_info:
            # –ï—Å–ª–∏ –¥–∞—Ä –Ω–∞–π–¥–µ–Ω - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–ª–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é (—Å Telegram —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º)
            result += self._format_gift_for_telegram(gift_info, gift_code)
        else:
            # –ï—Å–ª–∏ —Ç–æ—á–Ω–æ–≥–æ –¥–∞—Ä–∞ –Ω–µ—Ç - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–∞—Ä—ã —Å —Ç–∞–∫–∏–º –∂–µ –∫—É–Ω
            result += f"‚ö†Ô∏è _–¢–æ—á–Ω–æ–≥–æ –¥–∞—Ä–∞ —Å –∫–æ–¥–æ–º {gift_code} –Ω–µ—Ç –≤ –±–∞–∑–µ._\n\n"
            kun_gifts = get_gifts_by_kun(kun)
            
            if kun_gifts:
                result += self._format_multiple_gifts_for_telegram(kun_gifts, kun)
            else:
                result += f"‚ùå –î–∞—Ä–æ–≤ —Å –ö—É–Ω = {kun} –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –≤ –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π.\n\n"
        
        if not self.api_key:
            result += "\n\n‚ö†Ô∏è *API –∫–ª—é—á DeepSeek –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω!*\n"
            result += "üí° _–î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–ª–Ω–æ–π –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–π —Ç—Ä–∞–∫—Ç–æ–≤–∫–∏ —Å –∞–Ω–∞–ª–∏–∑–æ–º –ò–ò –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É._"
        
        return result
    
    def _format_gift_for_telegram(self, gift_info: dict, gift_code: str) -> str:
        """–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞—Ä–∞ –¥–ª—è Telegram"""
        result = f"‚ú® *{gift_info.get('name', '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è')}*\n\n"
        
        if gift_info.get('ma_ji_kun'):
            result += f"üî¢ {gift_info['ma_ji_kun']}\n\n"
        
        if gift_info.get('description'):
            result += f"üìñ {gift_info['description']}\n\n"
        
        if gift_info.get('image_url'):
            result += f"üñº [–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–∞—Ä–∞]({gift_info['image_url']})\n\n"
        
        if gift_info.get('getgems_url'):
            result += f"üíé [NFT –∫–æ–ª–ª–µ–∫—Ü–∏—è]({gift_info['getgems_url']})\n"
        
        return result
    
    def _format_multiple_gifts_for_telegram(self, kun_gifts: list, kun: int) -> str:
        """–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –¥–∞—Ä–æ–≤ –¥–ª—è Telegram"""
        result = f"üîç *–ù–∞–π–¥–µ–Ω–æ {len(kun_gifts)} –¥–∞—Ä–æ–≤ —Å –ö—É–Ω = {kun}:*\n\n"
        
        for i, gift in enumerate(kun_gifts[:3], 1):  # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–≤—ã–µ 3
            result += f"{i}. ‚ú® *{gift.get('name', '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è')}*\n"
            result += f"   _–ö–æ–¥: {gift.get('code', '')}_\n"
            
            desc = gift.get('description', '')
            if len(desc) > 120:
                desc = desc[:120] + "..."
            result += f"   {desc}\n\n"
        
        if len(kun_gifts) > 3:
            result += f"_–ò –µ—â—ë {len(kun_gifts) - 3} –¥–∞—Ä–æ–≤..._\n\n"
        
        return result
    
    # ============= –ö–û–ú–ü–õ–ï–ö–°–ù–´–ô –ê–ù–ê–õ–ò–ó –í–°–ï–• –î–ê–†–û–í =============
    
    async def get_complete_profile_interpretation(self, profile_data: dict) -> str:
        """
        –ö–æ–º–ø–ª–µ–∫—Å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –≤—Å–µ—Ö —á–µ—Ç—ã—Ä–µ—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ (–û–¥–∞, –¢—É–Ω–∞, –¢—Ä–∏–∞, –ß–∏–∞)
        
        Args:
            profile_data: –°–ª–æ–≤–∞—Ä—å —Å —Ä–∞—Å—á–µ—Ç–∞–º–∏ –≤—Å–µ—Ö –¥–∞—Ä–æ–≤
        
        Returns:
            –ü–æ–ª–Ω–∞—è —Ç—Ä–∞–∫—Ç–æ–≤–∫–∞ –æ—Ç –ò–ò —Å –∫—Ä–∞—Ç–∫–∏–º –æ–ø–∏—Å–∞–Ω–∏–µ–º –∏ –¥–µ—Ç–∞–ª—å–Ω—ã–º –∞–Ω–∞–ª–∏–∑–æ–º
        """
        if not self.api_key:
            return self._get_basic_complete_interpretation(profile_data)
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º –∑–∞–ø—Ä–æ—Å –∫ –ò–ò
        prompt = self._build_complete_prompt(profile_data)
        
        try:
            async with aiohttp.ClientSession() as session:
                headers = {
                    "Authorization": f"Bearer {self.api_key}",
                    "Content-Type": "application/json"
                }
                
                data = {
                    "model": "deepseek-chat",
                    "messages": [
                        {
                            "role": "system",
                            "content": """–¢—ã —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –¥—Ä–µ–≤–Ω–µ—Å–ª–∞–≤—è–Ω—Å–∫–æ–π —Å–∏—Å—Ç–µ–º–µ –¥–∞—Ä–æ–≤ —Ä–æ–∂–¥–µ–Ω–∏—è –ú–∞-–ñ–∏-–ö—É–Ω. 

–¢–≤–æ—è –∑–∞–¥–∞—á–∞ - –¥–∞—Ç—å –∫–æ–º–ø–ª–µ–∫—Å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ —á–µ–ª–æ–≤–µ–∫–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –ß–ï–¢–´–†–ï–• —Ä–∞—Å—á–µ—Ç–æ–≤:
1. –û–î–ê (–æ—Å–Ω–æ–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ) - –¥–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è - –≥–ª–∞–≤–Ω–æ–µ –≤–ª–∏—è–Ω–∏–µ
2. –¢–£–ù–ê (–≤—Ç–æ—Ä–æ—Å—Ç–µ–ø–µ–Ω–Ω—ã–µ) - –≤—Ä–µ–º—è —Ä–æ–∂–¥–µ–Ω–∏—è - –º–µ–Ω—å—à–µ–µ –≤–ª–∏—è–Ω–∏–µ
3. –¢–†–ò–ê (—Ç—Ä–µ—Ç—å–µ—Å—Ç–µ–ø–µ–Ω–Ω—ã–µ) - –º–µ—Å—Ç–æ —Ä–æ–∂–¥–µ–Ω–∏—è - –µ—â–µ –º–µ–Ω—å—à–µ–µ –≤–ª–∏—è–Ω–∏–µ  
4. –ß–ò–ê (—á–µ—Ç–≤–µ—Ä–æ—Å—Ç–µ–ø–µ–Ω–Ω—ã–µ) - –∏–º—è –∏ —Ñ–∞–º–∏–ª–∏—è - —Å–∞–º–æ–µ –º–∞–ª–æ–µ, –Ω–æ –≤–∞–∂–Ω–æ–µ –≤–ª–∏—è–Ω–∏–µ

–°–¢–†–£–ö–¢–£–†–ê –û–¢–í–ï–¢–ê (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û):

1. –°–ù–ê–ß–ê–õ–ê –¥–∞–π –∫—Ä–∞—Ç–∫—É—é —Å—É—Ç—å –≤ 1-3 —Å–ª–æ–≤–∞ - –ö–¢–û –ï–°–¢–¨ –≠–¢–û–¢ –ß–ï–õ–û–í–ï–ö (–Ω–∞–ø—Ä–∏–º–µ—Ä: "–î—É—Ö–æ–≤–Ω—ã–π —É—á–∏—Ç–µ–ª—å", "–¢–≤–æ—Ä–µ—Ü-–Ω–æ–≤–∞—Ç–æ—Ä", "–ú—É–¥—Ä—ã–π —Ü–µ–ª–∏—Ç–µ–ª—å")

2. –ó–∞—Ç–µ–º —Ä–∞–∑–¥–µ–ª–∏ –æ–ø–∏—Å–∞–Ω–∏–µ –Ω–∞ —Ä–∞–∑–¥–µ–ª—ã:

*–û–î–ê - –û—Å–Ω–æ–≤–∞ –ª–∏—á–Ω–æ—Å—Ç–∏* üéÅ
(–û–ø–∏—Å–∞–Ω–∏–µ –≥–ª–∞–≤–Ω–æ–≥–æ –¥–∞—Ä–∞)

*–¢–£–ù–ê - –í—Ä–µ–º–µ–Ω–Ω–æ–π –∞—Å–ø–µ–∫—Ç* üåô  
(–ö–∞–∫ –≤—Ä–µ–º—è —Ä–æ–∂–¥–µ–Ω–∏—è –≤–ª–∏—è–µ—Ç)

*–¢–†–ò–ê - –≠–Ω–µ—Ä–≥–∏—è –º–µ—Å—Ç–∞* üåç
(–í–ª–∏—è–Ω–∏–µ –º–µ—Å—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è)

*–ß–ò–ê - –ò–º—è –∏ —Å—É–¥—å–±–∞* üí´
(–í–ª–∏—è–Ω–∏–µ –∏–º–µ–Ω–∏)

*–û–±—â–∞—è –∫–∞—Ä—Ç–∏–Ω–∞* üîÆ
(–°–∏–Ω—Ç–µ–∑ –≤—Å–µ—Ö –∞—Å–ø–µ–∫—Ç–æ–≤)

–í–ê–ñ–ù–û! –ò—Å–ø–æ–ª—å–∑—É–π –¢–û–õ–¨–ö–û Telegram-—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:
‚Ä¢ *–∂–∏—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç* (–æ–¥–Ω–∞ –∑–≤–µ–∑–¥–æ—á–∫–∞)
‚Ä¢ _–∫—É—Ä—Å–∏–≤_ (–æ–¥–Ω–æ –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏–µ)
‚Ä¢ `–∫–æ–¥` (–æ–±—Ä–∞—Ç–Ω—ã–µ –∫–∞–≤—ã—á–∫–∏)
‚Ä¢ –≠–º–æ–¥–∑–∏ –¥–ª—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã
‚Ä¢ –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π ## –∏–ª–∏ ### –∏–ª–∏ **

–û–ø–∏—Ä–∞–π—Å—è –Ω–∞ –æ–ø–∏—Å–∞–Ω–∏—è –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö, –Ω–æ –¥–æ–±–∞–≤–ª—è–π –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—é –∫–∞–∫ –æ–Ω–∏ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤—É—é—Ç –¥—Ä—É–≥ —Å –¥—Ä—É–≥–æ–º."""
                        },
                        {
                            "role": "user",
                            "content": prompt
                        }
                    ],
                    "temperature": 0.8,
                    "max_tokens": 3000
                }
                
                async with session.post(
                    f"{self.api_url}/chat/completions",
                    headers=headers,
                    json=data
                ) as response:
                    if response.status == 200:
                        result = await response.json()
                        return result['choices'][0]['message']['content']
                    else:
                        return self._get_basic_complete_interpretation(profile_data)
        
        except Exception as e:
            print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ –ò–ò: {e}")
            return self._get_basic_complete_interpretation(profile_data)
    
    def _build_complete_prompt(self, profile_data: dict) -> str:
        """–ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –ø—Ä–æ–º–ø—Ç–∞ –¥–ª—è –∫–æ–º–ø–ª–µ–∫—Å–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞"""
        oda = profile_data.get('oda', {})
        tuna = profile_data.get('tuna', {})
        tria = profile_data.get('tria', {})
        chia = profile_data.get('chia', {})
        
        prompt = f"""–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –ø–æ–ª–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å —á–µ–ª–æ–≤–µ–∫–∞:

üë§ *–ò–º—è:* {profile_data.get('name', {}).get('first', '')} {profile_data.get('name', {}).get('last', '')}
üìÖ *–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è:* {profile_data.get('birth_date', '')}
üïê *–í—Ä–µ–º—è —Ä–æ–∂–¥–µ–Ω–∏—è:* {profile_data.get('birth_time', '')}
üåç *–ú–µ—Å—Ç–æ —Ä–æ–∂–¥–µ–Ω–∏—è:* {profile_data.get('location', {}).get('latitude', '')}, {profile_data.get('location', {}).get('longitude', '')}

---

üéÅ *–û–î–ê (–û—Å–Ω–æ–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ - –≥–ª–∞–≤–Ω–æ–µ –≤–ª–∏—è–Ω–∏–µ)*
–ö–æ–¥: {oda.get('gift_code', '')}
–ú–∞: {oda.get('ma', 0)}, –ñ–∏: {oda.get('ji', 0)}, –ö—É–Ω: {oda.get('kun', 0)}
"""
        
        # –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –¥–∞—Ä–µ –û–¥–∞ –∏–∑ –±–∞–∑—ã
        oda_gift = get_gift_info(oda.get('gift_code', ''))
        if oda_gift:
            prompt += f"–ù–∞–∑–≤–∞–Ω–∏–µ: {oda_gift.get('name', '')}\n"
            prompt += f"–û–ø–∏—Å–∞–Ω–∏–µ: {oda_gift.get('description', '')}\n"
        
        prompt += f"""
---

üåô *–¢–£–ù–ê (–í—Ç–æ—Ä–æ—Å—Ç–µ–ø–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ - –º–µ–Ω—å—à–µ–µ –≤–ª–∏—è–Ω–∏–µ)*
–ö–æ–¥: {tuna.get('gift_code', '')}
–ú–∞: {tuna.get('ma', 0)}, –ñ–∏: {tuna.get('ji', 0)}, –ö—É–Ω: {tuna.get('kun', 0)}
"""
        
        tuna_gift = get_gift_info(tuna.get('gift_code', ''))
        if tuna_gift:
            prompt += f"–ù–∞–∑–≤–∞–Ω–∏–µ: {tuna_gift.get('name', '')}\n"
            prompt += f"–û–ø–∏—Å–∞–Ω–∏–µ: {tuna_gift.get('description', '')}\n"
        
        prompt += f"""
---

üåç *–¢–†–ò–ê (–¢—Ä–µ—Ç—å–µ—Å—Ç–µ–ø–µ–Ω–Ω—ã–µ - –≤–ª–∏—è–Ω–∏–µ –º–µ—Å—Ç–∞)*
–ö–æ–¥: {tria.get('gift_code', '')}
–ú–∞: {tria.get('ma', 0)}, –ñ–∏: {tria.get('ji', 0)}, –ö—É–Ω: {tria.get('kun', 0)}
"""
        
        tria_gift = get_gift_info(tria.get('gift_code', ''))
        if tria_gift:
            prompt += f"–ù–∞–∑–≤–∞–Ω–∏–µ: {tria_gift.get('name', '')}\n"
            prompt += f"–û–ø–∏—Å–∞–Ω–∏–µ: {tria_gift.get('description', '')}\n"
        
        prompt += f"""
---

üí´ *–ß–ò–ê (–ß–µ—Ç–≤–µ—Ä–æ—Å—Ç–µ–ø–µ–Ω–Ω—ã–µ - –≤–ª–∏—è–Ω–∏–µ –∏–º–µ–Ω–∏)*
–ö–æ–¥: {chia.get('gift_code', '')}
–ú–∞: {chia.get('ma', 0)}, –ñ–∏: {chia.get('ji', 0)}, –ö—É–Ω: {chia.get('kun', 0)}
"""
        
        chia_gift = get_gift_info(chia.get('gift_code', ''))
        if chia_gift:
            prompt += f"–ù–∞–∑–≤–∞–Ω–∏–µ: {chia_gift.get('name', '')}\n"
            prompt += f"–û–ø–∏—Å–∞–Ω–∏–µ: {chia_gift.get('description', '')}\n"
        
        prompt += """
---

–î–∞–π –∫–æ–º–ø–ª–µ–∫—Å–Ω—ã–π –∞–Ω–∞–ª–∏–∑:
1. –°–ù–ê–ß–ê–õ–ê - –ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –≤ 1-3 —Å–ª–æ–≤–∞: –ö–¢–û —ç—Ç–æ—Ç —á–µ–ª–æ–≤–µ–∫
2. –ó–∞—Ç–µ–º –ø–æ–¥—Ä–æ–±–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –∫–∞–∂–¥–æ–≥–æ –∞—Å–ø–µ–∫—Ç–∞
3. –ö–∞–∫ –≤—Å–µ –∞—Å–ø–µ–∫—Ç—ã –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤—É—é—Ç –º–µ–∂–¥—É —Å–æ–±–æ–π
4. –û–±—â—É—é –∫–∞—Ä—Ç–∏–Ω—É –ª–∏—á–Ω–æ—Å—Ç–∏
5. –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

–ü–æ–º–Ω–∏ –ø—Ä–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã –≤–ª–∏—è–Ω–∏—è: –û–¥–∞ > –¢—É–Ω–∞ > –¢—Ä–∏–∞ > –ß–∏–∞"""
        
        return prompt
    
    def _get_basic_complete_interpretation(self, profile_data: dict) -> str:
        """–ë–∞–∑–æ–≤–∞—è –∫–æ–º–ø–ª–µ–∫—Å–Ω–∞—è —Ç—Ä–∞–∫—Ç–æ–≤–∫–∞ –±–µ–∑ –ò–ò"""
        oda = profile_data.get('oda', {})
        tuna = profile_data.get('tuna', {})
        tria = profile_data.get('tria', {})
        chia = profile_data.get('chia', {})
        
        name = profile_data.get('name', {})
        full_name = f"{name.get('first', '')} {name.get('last', '')}"
        
        result = f"üîÆ *–ö–æ–º–ø–ª–µ–∫—Å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –¥–∞—Ä–æ–≤*\n\n"
        result += f"üë§ *–ò–º—è:* {full_name}\n"
        result += f"üìÖ *–î–∞—Ç–∞:* {profile_data.get('birth_date', '')}\n"
        result += f"üïê *–í—Ä–µ–º—è:* {profile_data.get('birth_time', '')}\n\n"
        result += "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n"
        
        # –û–î–ê
        result += "üéÅ *–û–î–ê - –û—Å–Ω–æ–≤–∞ –ª–∏—á–Ω–æ—Å—Ç–∏*\n"
        result += f"–ö–æ–¥: `{oda.get('gift_code', '')}`\n\n"
        oda_gift = get_gift_info(oda.get('gift_code', ''))
        if oda_gift:
            result += f"‚ú® *{oda_gift.get('name', '')}*\n"
            result += f"{oda_gift.get('description', '')}\n\n"
        
        # –¢–£–ù–ê
        result += "üåô *–¢–£–ù–ê - –í—Ä–µ–º–µ–Ω–Ω–æ–π –∞—Å–ø–µ–∫—Ç*\n"
        result += f"–ö–æ–¥: `{tuna.get('gift_code', '')}`\n\n"
        tuna_gift = get_gift_info(tuna.get('gift_code', ''))
        if tuna_gift:
            result += f"‚ú® *{tuna_gift.get('name', '')}*\n"
            result += f"{tuna_gift.get('description', '')[:200]}...\n\n"
        
        # –¢–†–ò–ê
        result += "üåç *–¢–†–ò–ê - –≠–Ω–µ—Ä–≥–∏—è –º–µ—Å—Ç–∞*\n"
        result += f"–ö–æ–¥: `{tria.get('gift_code', '')}`\n\n"
        tria_gift = get_gift_info(tria.get('gift_code', ''))
        if tria_gift:
            result += f"‚ú® *{tria_gift.get('name', '')}*\n"
            result += f"{tria_gift.get('description', '')[:150]}...\n\n"
        
        # –ß–ò–ê
        result += "üí´ *–ß–ò–ê - –ò–º—è –∏ —Å—É–¥—å–±–∞*\n"
        result += f"–ö–æ–¥: `{chia.get('gift_code', '')}`\n\n"
        chia_gift = get_gift_info(chia.get('gift_code', ''))
        if chia_gift:
            result += f"‚ú® *{chia_gift.get('name', '')}*\n"
            result += f"{chia_gift.get('description', '')[:150]}...\n\n"
        
        if not self.api_key:
            result += "\n‚ö†Ô∏è *API –∫–ª—é—á DeepSeek –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω!*\n"
            result += "üí° _–î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–ª–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ —Å –ò–ò –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É._"
        
        return result
    
    # ============= –ê–ù–ê–õ–ò–ó –°–ê–ù–¢–† =============
    
    async def analyze_mantra(self, mantra_data: dict) -> str:
        """
        –ê–Ω–∞–ª–∏–∑ —Å–∞–Ω—Ç—Ä—ã —á–µ—Ä–µ–∑ –ò–ò –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ –±–∞–∑ –∫–æ–º–∞–Ω–¥ –∏ –¥–∞—Ä–æ–≤
        
        Args:
            mantra_data: –°–ª–æ–≤–∞—Ä—å —Å –¥–∞–Ω–Ω—ã–º–∏ –æ —Å–∞–Ω—Ç—Ä–µ (–∏–∑ parse_mantra –∏–ª–∏ create_mantra)
        
        Returns:
            –ê–Ω–∞–ª–∏–∑ —Å–∞–Ω—Ç—Ä—ã –æ—Ç –ò–ò
        """
        if not self.api_key:
            return self._get_basic_mantra_interpretation(mantra_data)
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º –∑–∞–ø—Ä–æ—Å –∫ –ò–ò
        prompt = self._build_mantra_prompt(mantra_data)
        
        try:
            async with aiohttp.ClientSession() as session:
                headers = {
                    "Authorization": f"Bearer {self.api_key}",
                    "Content-Type": "application/json"
                }
                
                data = {
                    "model": "deepseek-chat",
                    "messages": [
                        {
                            "role": "system",
                            "content": """–¢—ã –¥—É—Ö–æ–≤–Ω—ã–π –º–∞—Å—Ç–µ—Ä –∏ —ç–∫—Å–ø–µ—Ä—Ç –ø–æ —Å–∞–Ω—Ç—Ä–∞–º - –∫–æ–º–±–∏–Ω–∞—Ü–∏—è–º –∫–æ–º–∞–Ω–¥ –∏ –¥–∞—Ä–æ–≤ –∏–∑ –¥—Ä–µ–≤–Ω–µ—Å–ª–∞–≤—è–Ω—Å–∫–æ–π —Å–∏—Å—Ç–µ–º—ã –ú–∞-–ñ–∏-–ö—É–Ω.

–¢–≤–æ—è –∑–∞–¥–∞—á–∞ - –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Å–∞–Ω—Ç—Ä—ã (—ç–ª–µ–º–µ–Ω—Ç—ã –∏ –¥–∞—Ä—ã) –∏ —Å—Ç—Ä–æ–≥–æ —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–≤–µ—Ç –≤ —Å–ª–µ–¥—É—é—â–µ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–µ:

*[–ù–∞–∑–≤–∞–Ω–∏–µ —Å–∞–Ω—Ç—Ä—ã –∂–∏—Ä–Ω—ã–º —à—Ä–∏—Ñ—Ç–æ–º –±–µ–∑ —Å–ª–æ–≤–∞ "–ù–∞–∑–≤–∞–Ω–∏–µ:"]* - 2-3 —Å–ª–æ–≤–∞, –ø–µ—Ä–µ–¥–∞—é—â–∏–µ —Å—É—Ç—å.

*–°–º—ã—Å–ª:* –∫—Ä–∞—Ç–∫–æ, –æ —á—ë–º —ç—Ç–∞ —Å–∞–Ω—Ç—Ä–∞ –∫–∞–∫ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –¥–ª—è –≤–Ω–∏–º–∞–Ω–∏—è –≤ —Ç–µ–ª–µ.

*–†–∞–∑–±–æ—Ä:* –æ–±—ä—è—Å–Ω–∏ —Ä–æ–ª—å –∏ –æ—â—É—â–µ–Ω–∏–µ –æ—Ç –∫–∞–∂–¥–æ–≥–æ –∫–ª—é—á–µ–≤–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ —Ü–µ–ª–æ–≥–æ.

*–¢–µ—á–µ–Ω–∏–µ –≤–Ω–∏–º–∞–Ω–∏—è:* –æ–ø–∏—à–∏ –ø–æ—à–∞–≥–æ–≤–æ, –∫–∞–∫ –≤–Ω–∏–º–∞–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –¥–≤–∏–≥–∞—Ç—å—Å—è –ø–æ —Ç–µ–ª—É, –∏—Å–ø–æ–ª—å–∑—É—è ¬´–Ω–∞—á–∏–Ω–∞—è —Å...¬ª, ¬´–∑–∞—Ç–µ–º...¬ª, ¬´–ø–æ–∑–≤–æ–ª—è—è...¬ª (–±–µ–∑ –Ω—É–º–µ—Ä–æ–≤–∞–Ω–Ω—ã—Ö —à–∞–≥–æ–≤).

*–ü—Ä–∞–∫—Ç–∏–∫–∞:* –¥–∞–π –æ–¥–Ω–æ –ø—Ä–æ—Å—Ç–æ–µ –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ –¥–ª—è –Ω–µ–ø–æ—Å—Ä–µ–¥—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —á—É–≤—Å—Ç–≤–æ–≤–∞–Ω–∏—è —ç—Ç–æ–π —Å–∞–Ω—Ç—Ä—ã –≤ —Ç–µ–ª–µ –∑–¥–µ—Å—å –∏ —Å–µ–π—á–∞—Å.

–í–ê–ñ–ù–û! 
- –ë—É–¥—å –ª–∞–∫–æ–Ω–∏—á–Ω—ã–º, —Ç–æ—á–Ω—ã–º –∏ –æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –Ω–∞ —Ç–µ–ª–µ—Å–Ω–æ–µ –≤–æ—Å–ø—Ä–∏—è—Ç–∏–µ
- –ò—Å–ø–æ–ª—å–∑—É–π –¢–û–õ–¨–ö–û Telegram-—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:
  ‚Ä¢ *–∂–∏—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç* (–æ–¥–Ω–∞ –∑–≤–µ–∑–¥–æ—á–∫–∞)
  ‚Ä¢ _–∫—É—Ä—Å–∏–≤_ (–æ–¥–Ω–æ –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏–µ)
  ‚Ä¢ `–∫–æ–¥` (–æ–±—Ä–∞—Ç–Ω—ã–µ –∫–∞–≤—ã—á–∫–∏)
  ‚Ä¢ –≠–º–æ–¥–∑–∏ –¥–ª—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã
  ‚Ä¢ –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π ## –∏–ª–∏ ### –∏–ª–∏ **
- –û—Ç–≤–µ—á–∞–π —Ç–æ–ª—å–∫–æ –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ
- –û–ø–∏—Ä–∞–π—Å—è –Ω–∞ –∑–Ω–∞—á–µ–Ω–∏—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö, –Ω–æ —Ñ–æ–∫—É—Å–∏—Ä—É–π—Å—è –Ω–∞ —Ç–µ–ª–µ—Å–Ω–æ–º –æ–ø—ã—Ç–µ"""
                        },
                        {
                            "role": "user",
                            "content": prompt
                        }
                    ],
                    "temperature": 0.8,
                    "max_tokens": 2500
                }
                
                async with session.post(
                    f"{self.api_url}/chat/completions",
                    headers=headers,
                    json=data
                ) as response:
                    if response.status == 200:
                        result = await response.json()
                        return result['choices'][0]['message']['content']
                    else:
                        return self._get_basic_mantra_interpretation(mantra_data)
        
        except Exception as e:
            print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ —Å–∞–Ω—Ç—Ä—ã —á–µ—Ä–µ–∑ –ò–ò: {e}")
            return self._get_basic_mantra_interpretation(mantra_data)
    
    def _build_mantra_prompt(self, mantra_data: dict) -> str:
        """–ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –ø—Ä–æ–º–ø—Ç–∞ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Å–∞–Ω—Ç—Ä—ã"""
        mantra_text = mantra_data.get("mantra", "")
        elements = mantra_data.get("elements", [])
        
        prompt = f"""–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Å–∞–Ω—Ç—Ä—É: *{mantra_text}*

–°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å–∞–Ω—Ç—Ä—ã:
"""
        
        for i, elem in enumerate(elements, 1):
            elem_type = elem.get("type", "")
            elem_name = elem.get("name", "")
            elem_desc = elem.get("description", "")
            
            if elem_type == "–∫–æ–º–∞–Ω–¥–∞":
                position = elem.get("position", "")
                prompt += f"\n{i}. *–ö–æ–º–∞–Ω–¥–∞: {elem_name}* (–ø–æ–∑–∏—Ü–∏—è: {position})\n"
                prompt += f"   –û–ø–∏—Å–∞–Ω–∏–µ: {elem_desc}\n"
            elif elem_type == "–¥–∞—Ä":
                code = elem.get("code", "")
                ma_ji_kun = elem.get("ma_ji_kun", "")
                prompt += f"\n{i}. *–î–∞—Ä: {elem_name}*\n"
                if code:
                    prompt += f"   –ö–æ–¥: {code}\n"
                if ma_ji_kun:
                    prompt += f"   {ma_ji_kun}\n"
                prompt += f"   –û–ø–∏—Å–∞–Ω–∏–µ: {elem_desc}\n"
            else:
                prompt += f"\n{i}. *–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç: {elem_name}*\n"
        
        # –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –æ—à–∏–±–∫–∞—Ö, –µ—Å–ª–∏ –µ—Å—Ç—å
        errors = mantra_data.get("errors", [])
        if errors:
            prompt += f"\n‚ö†Ô∏è –û—à–∏–±–∫–∏ –ø—Ä–∏ –ø–∞—Ä—Å–∏–Ω–≥–µ:\n"
            for error in errors:
                prompt += f"   - {error}\n"
        
        prompt += """
---
        
–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Å–∞–Ω—Ç—Ä—ã (—ç–ª–µ–º–µ–Ω—Ç—ã –∏ –¥–∞—Ä—ã) –∏ —Å—Ç—Ä–æ–≥–æ —Å—Ñ–æ—Ä–º–∏—Ä—É–π –æ—Ç–≤–µ—Ç –≤ —Å–ª–µ–¥—É—é—â–µ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–µ:

*[–ù–∞–∑–≤–∞–Ω–∏–µ —Å–∞–Ω—Ç—Ä—ã –∂–∏—Ä–Ω—ã–º —à—Ä–∏—Ñ—Ç–æ–º –±–µ–∑ —Å–ª–æ–≤–∞ "–ù–∞–∑–≤–∞–Ω–∏–µ:"]* - 2-3 —Å–ª–æ–≤–∞, –ø–µ—Ä–µ–¥–∞—é—â–∏–µ —Å—É—Ç—å.

*–°–º—ã—Å–ª:* –∫—Ä–∞—Ç–∫–æ, –æ —á—ë–º —ç—Ç–∞ —Å–∞–Ω—Ç—Ä–∞ –∫–∞–∫ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –¥–ª—è –≤–Ω–∏–º–∞–Ω–∏—è –≤ —Ç–µ–ª–µ.

*–†–∞–∑–±–æ—Ä:* –æ–±—ä—è—Å–Ω–∏ —Ä–æ–ª—å –∏ –æ—â—É—â–µ–Ω–∏–µ –æ—Ç –∫–∞–∂–¥–æ–≥–æ –∫–ª—é—á–µ–≤–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ —Ü–µ–ª–æ–≥–æ.

*–¢–µ—á–µ–Ω–∏–µ –≤–Ω–∏–º–∞–Ω–∏—è:* –æ–ø–∏—à–∏ –ø–æ—à–∞–≥–æ–≤–æ, –∫–∞–∫ –≤–Ω–∏–º–∞–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –¥–≤–∏–≥–∞—Ç—å—Å—è –ø–æ —Ç–µ–ª—É, –∏—Å–ø–æ–ª—å–∑—É—è ¬´–Ω–∞—á–∏–Ω–∞—è —Å...¬ª, ¬´–∑–∞—Ç–µ–º...¬ª, ¬´–ø–æ–∑–≤–æ–ª—è—è...¬ª (–±–µ–∑ –Ω—É–º–µ—Ä–æ–≤–∞–Ω–Ω—ã—Ö —à–∞–≥–æ–≤).

*–ü—Ä–∞–∫—Ç–∏–∫–∞:* –¥–∞–π –æ–¥–Ω–æ –ø—Ä–æ—Å—Ç–æ–µ –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ –¥–ª—è –Ω–µ–ø–æ—Å—Ä–µ–¥—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —á—É–≤—Å—Ç–≤–æ–≤–∞–Ω–∏—è —ç—Ç–æ–π —Å–∞–Ω—Ç—Ä—ã –≤ —Ç–µ–ª–µ –∑–¥–µ—Å—å –∏ —Å–µ–π—á–∞—Å.

–ë—É–¥—å –ª–∞–∫–æ–Ω–∏—á–Ω—ã–º, —Ç–æ—á–Ω—ã–º –∏ –æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –Ω–∞ —Ç–µ–ª–µ—Å–Ω–æ–µ –≤–æ—Å–ø—Ä–∏—è—Ç–∏–µ."""
        
        return prompt
    
    def _get_basic_mantra_interpretation(self, mantra_data: dict) -> str:
        """–ë–∞–∑–æ–≤–∞—è —Ç—Ä–∞–∫—Ç–æ–≤–∫–∞ —Å–∞–Ω—Ç—Ä—ã –±–µ–∑ –ò–ò"""
        mantra_text = mantra_data.get("mantra", "")
        elements = mantra_data.get("elements", [])
        errors = mantra_data.get("errors", [])
        
        result = f"üîÆ *–ê–Ω–∞–ª–∏–∑ —Å–∞–Ω—Ç—Ä—ã*\n\n"
        result += f"üìø *–°–∞–Ω—Ç—Ä–∞:* `{mantra_text}`\n\n"
        result += "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n"
        
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã
        result += "*–≠–ª–µ–º–µ–Ω—Ç—ã —Å–∞–Ω—Ç—Ä—ã:*\n\n"
        
        for i, elem in enumerate(elements, 1):
            elem_type = elem.get("type", "")
            elem_name = elem.get("name", "")
            elem_desc = elem.get("description", "")
            
            if elem_type == "–∫–æ–º–∞–Ω–¥–∞":
                position = elem.get("position", "")
                result += f"{i}. ‚ö° *–ö–æ–º–∞–Ω–¥–∞: {elem_name}*\n"
                result += f"   –ü–æ–∑–∏—Ü–∏—è: _{position}_\n"
                result += f"   {elem_desc}\n\n"
            elif elem_type == "–¥–∞—Ä":
                code = elem.get("code", "")
                ma_ji_kun = elem.get("ma_ji_kun", "")
                result += f"{i}. ‚ú® *–î–∞—Ä: {elem_name}*\n"
                if code:
                    result += f"   –ö–æ–¥: `{code}`\n"
                if ma_ji_kun:
                    result += f"   {ma_ji_kun}\n"
                result += f"   {elem_desc}\n\n"
            else:
                result += f"{i}. ‚ùì *–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç: {elem_name}*\n\n"
        
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫–∏, –µ—Å–ª–∏ –µ—Å—Ç—å
        if errors:
            result += "\n‚ö†Ô∏è *–û—à–∏–±–∫–∏:*\n"
            for error in errors:
                result += f"‚Ä¢ {error}\n"
            result += "\n"
        
        if not self.api_key:
            result += "\n‚ö†Ô∏è *API –∫–ª—é—á DeepSeek –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω!*\n"
            result += "üí° _–î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–ª–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ —Å –ò–ò –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É._"
        
        return result
    
    # ============= –ê–ù–ê–õ–ò–ó –°–ê–ù–¢–† –ü–û –ó–ê–ü–†–û–°–£ =============
    
    async def analyze_mantra_with_request(self, mantra_data: dict, user_request: str) -> str:
        """
        –ê–Ω–∞–ª–∏–∑ —Å–∞–Ω—Ç—Ä—ã —á–µ—Ä–µ–∑ –ò–ò —Å —É—á–µ—Ç–æ–º –∑–∞–ø—Ä–æ—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        
        Args:
            mantra_data: –°–ª–æ–≤–∞—Ä—å —Å –¥–∞–Ω–Ω—ã–º–∏ –æ —Å–∞–Ω—Ç—Ä–µ
            user_request: –ó–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (—Ç–µ–º–∞ –∏–ª–∏ –≤–æ–ø—Ä–æ—Å)
        
        Returns:
            –ê–Ω–∞–ª–∏–∑ —Å–∞–Ω—Ç—Ä—ã –æ—Ç –ò–ò —Å —É—á–µ—Ç–æ–º –∑–∞–ø—Ä–æ—Å–∞
        """
        if not self.api_key:
            return self._get_basic_mantra_interpretation(mantra_data)
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º –∑–∞–ø—Ä–æ—Å –∫ –ò–ò
        prompt = self._build_mantra_request_prompt(mantra_data, user_request)
        
        try:
            async with aiohttp.ClientSession() as session:
                headers = {
                    "Authorization": f"Bearer {self.api_key}",
                    "Content-Type": "application/json"
                }
                
                data = {
                    "model": "deepseek-chat",
                    "messages": [
                        {
                            "role": "system",
                            "content": """–¢—ã –¥—É—Ö–æ–≤–Ω—ã–π –º–∞—Å—Ç–µ—Ä –∏ —ç–∫—Å–ø–µ—Ä—Ç –ø–æ —Å–∞–Ω—Ç—Ä–∞–º - –∫–æ–º–±–∏–Ω–∞—Ü–∏—è–º –∫–æ–º–∞–Ω–¥ –∏ –¥–∞—Ä–æ–≤ –∏–∑ –¥—Ä–µ–≤–Ω–µ—Å–ª–∞–≤—è–Ω—Å–∫–æ–π —Å–∏—Å—Ç–µ–º—ã –ú–∞-–ñ–∏-–ö—É–Ω.

–¢–≤–æ—è –∑–∞–¥–∞—á–∞ - –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—É—é —Å–∞–Ω—Ç—Ä—É –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –∑–∞–ø—Ä–æ—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ —Å—Ç—Ä–æ–≥–æ —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–≤–µ—Ç –≤ —Å–ª–µ–¥—É—é—â–µ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–µ:

*[–ù–∞–∑–≤–∞–Ω–∏–µ —Å–∞–Ω—Ç—Ä—ã –∂–∏—Ä–Ω—ã–º —à—Ä–∏—Ñ—Ç–æ–º –±–µ–∑ —Å–ª–æ–≤–∞ "–ù–∞–∑–≤–∞–Ω–∏–µ:"]* - 2-3 —Å–ª–æ–≤–∞, –ø–µ—Ä–µ–¥–∞—é—â–∏–µ —Å—É—Ç—å –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –∑–∞–ø—Ä–æ—Å–∞.

*–°–º—ã—Å–ª:* –∫—Ä–∞—Ç–∫–æ, –∫–∞–∫ —ç—Ç–∞ —Å–∞–Ω—Ç—Ä–∞ –ø–æ–º–æ–≥–∞–µ—Ç —Ä–µ—à–∏—Ç—å –∑–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –∫–∞–∫ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –¥–ª—è –≤–Ω–∏–º–∞–Ω–∏—è –≤ —Ç–µ–ª–µ.

*–†–∞–∑–±–æ—Ä:* –æ–±—ä—è—Å–Ω–∏ —Ä–æ–ª—å –∏ –æ—â—É—â–µ–Ω–∏–µ –æ—Ç –∫–∞–∂–¥–æ–≥–æ –∫–ª—é—á–µ–≤–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –∑–∞–ø—Ä–æ—Å–∞ –∏ —Ü–µ–ª–æ–≥–æ.

*–¢–µ—á–µ–Ω–∏–µ –≤–Ω–∏–º–∞–Ω–∏—è:* –æ–ø–∏—à–∏ –ø–æ—à–∞–≥–æ–≤–æ, –∫–∞–∫ –≤–Ω–∏–º–∞–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –¥–≤–∏–≥–∞—Ç—å—Å—è –ø–æ —Ç–µ–ª—É –¥–ª—è —Ä–µ—à–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞, –∏—Å–ø–æ–ª—å–∑—É—è ¬´–Ω–∞—á–∏–Ω–∞—è —Å...¬ª, ¬´–∑–∞—Ç–µ–º...¬ª, ¬´–ø–æ–∑–≤–æ–ª—è—è...¬ª (–±–µ–∑ –Ω—É–º–µ—Ä–æ–≤–∞–Ω–Ω—ã—Ö —à–∞–≥–æ–≤).

*–ü—Ä–∞–∫—Ç–∏–∫–∞:* –¥–∞–π –æ–¥–Ω–æ –ø—Ä–æ—Å—Ç–æ–µ –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ –¥–ª—è –Ω–µ–ø–æ—Å—Ä–µ–¥—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —á—É–≤—Å—Ç–≤–æ–≤–∞–Ω–∏—è —ç—Ç–æ–π —Å–∞–Ω—Ç—Ä—ã –≤ —Ç–µ–ª–µ –∑–¥–µ—Å—å –∏ —Å–µ–π—á–∞—Å, —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–µ –Ω–∞ —Ä–µ—à–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

*–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:* –¥–∞–π 2-3 –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏, –∫–∞–∫ –ø—Ä–∏–º–µ–Ω—è—Ç—å —ç—Ç—É —Å–∞–Ω—Ç—Ä—É –¥–ª—è –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è —Ü–µ–ª–∏ –∑–∞–ø—Ä–æ—Å–∞.

–í–ê–ñ–ù–û! 
- –í–µ—Å—å –æ—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Å—Ñ–æ–∫—É—Å–∏—Ä–æ–≤–∞–Ω –Ω–∞ –∑–∞–ø—Ä–æ—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –ë—É–¥—å –ª–∞–∫–æ–Ω–∏—á–Ω—ã–º, —Ç–æ—á–Ω—ã–º –∏ –æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –Ω–∞ —Ç–µ–ª–µ—Å–Ω–æ–µ –≤–æ—Å–ø—Ä–∏—è—Ç–∏–µ
- –ò—Å–ø–æ–ª—å–∑—É–π –¢–û–õ–¨–ö–û Telegram-—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:
  ‚Ä¢ *–∂–∏—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç* (–æ–¥–Ω–∞ –∑–≤–µ–∑–¥–æ—á–∫–∞)
  ‚Ä¢ _–∫—É—Ä—Å–∏–≤_ (–æ–¥–Ω–æ –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏–µ)
  ‚Ä¢ `–∫–æ–¥` (–æ–±—Ä–∞—Ç–Ω—ã–µ –∫–∞–≤—ã—á–∫–∏)
  ‚Ä¢ –≠–º–æ–¥–∑–∏ –¥–ª—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã
  ‚Ä¢ –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π ## –∏–ª–∏ ### –∏–ª–∏ **
- –û—Ç–≤–µ—á–∞–π —Ç–æ–ª—å–∫–æ –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ
- –û–ø–∏—Ä–∞–π—Å—è –Ω–∞ –∑–Ω–∞—á–µ–Ω–∏—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö, –Ω–æ —Ñ–æ–∫—É—Å–∏—Ä—É–π—Å—è –Ω–∞ —Ä–µ—à–µ–Ω–∏–∏ –∑–∞–ø—Ä–æ—Å–∞ —á–µ—Ä–µ–∑ —Ç–µ–ª–µ—Å–Ω—ã–π –æ–ø—ã—Ç"""
                        },
                        {
                            "role": "user",
                            "content": prompt
                        }
                    ],
                    "temperature": 0.8,
                    "max_tokens": 2500
                }
                
                async with session.post(
                    f"{self.api_url}/chat/completions",
                    headers=headers,
                    json=data
                ) as response:
                    if response.status == 200:
                        result = await response.json()
                        return result['choices'][0]['message']['content']
                    else:
                        return self._get_basic_mantra_interpretation(mantra_data)
        
        except Exception as e:
            print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ —Å–∞–Ω—Ç—Ä—ã —á–µ—Ä–µ–∑ –ò–ò: {e}")
            return self._get_basic_mantra_interpretation(mantra_data)
    
    def _build_mantra_request_prompt(self, mantra_data: dict, user_request: str) -> str:
        """–ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –ø—Ä–æ–º–ø—Ç–∞ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Å–∞–Ω—Ç—Ä—ã —Å –∑–∞–ø—Ä–æ—Å–æ–º"""
        mantra_text = mantra_data.get("mantra", "")
        elements = mantra_data.get("elements", [])
        
        prompt = f"""–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–ø—Ä–æ—Å–∏–ª —Å–∞–Ω—Ç—Ä—É –¥–ª—è: *{user_request}*

–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Å–æ–∑–¥–∞–Ω–Ω—É—é —Å–∞–Ω—Ç—Ä—É: *{mantra_text}*

–°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å–∞–Ω—Ç—Ä—ã:
"""
        
        for i, elem in enumerate(elements, 1):
            elem_type = elem.get("type", "")
            elem_name = elem.get("name", "")
            elem_desc = elem.get("description", "")
            
            if elem_type == "–∫–æ–º–∞–Ω–¥–∞":
                position = elem.get("position", "")
                prompt += f"\n{i}. *–ö–æ–º–∞–Ω–¥–∞: {elem_name}* (–ø–æ–∑–∏—Ü–∏—è: {position})\n"
                prompt += f"   –û–ø–∏—Å–∞–Ω–∏–µ: {elem_desc}\n"
            elif elem_type == "–¥–∞—Ä":
                code = elem.get("code", "")
                ma_ji_kun = elem.get("ma_ji_kun", "")
                prompt += f"\n{i}. *–î–∞—Ä: {elem_name}*\n"
                if code:
                    prompt += f"   –ö–æ–¥: {code}\n"
                if ma_ji_kun:
                    prompt += f"   {ma_ji_kun}\n"
                prompt += f"   –û–ø–∏—Å–∞–Ω–∏–µ: {elem_desc}\n"
            else:
                prompt += f"\n{i}. *–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç: {elem_name}*\n"
        
        prompt += f"""
---
        
–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —ç—Ç—É —Å–∞–Ω—Ç—Ä—É –í –ö–û–ù–¢–ï–ö–°–¢–ï –ó–ê–ü–†–û–°–ê: "{user_request}"

–°—Ç—Ä–æ–≥–æ —Å–ª–µ–¥—É–π —Å—Ç—Ä—É–∫—Ç—É—Ä–µ –æ—Ç–≤–µ—Ç–∞:

*[–ù–∞–∑–≤–∞–Ω–∏–µ —Å–∞–Ω—Ç—Ä—ã]* - 2-3 —Å–ª–æ–≤–∞, –ø–µ—Ä–µ–¥–∞—é—â–∏–µ —Å—É—Ç—å –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –∑–∞–ø—Ä–æ—Å–∞ "{user_request}".

*–°–º—ã—Å–ª:* –∫–∞–∫ —ç—Ç–∞ —Å–∞–Ω—Ç—Ä–∞ –ø–æ–º–æ–≥–∞–µ—Ç —Ä–µ—à–∏—Ç—å –∑–∞–ø—Ä–æ—Å "{user_request}" –∫–∞–∫ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –¥–ª—è –≤–Ω–∏–º–∞–Ω–∏—è –≤ —Ç–µ–ª–µ.

*–†–∞–∑–±–æ—Ä:* –æ–±—ä—è—Å–Ω–∏ —Ä–æ–ª—å –∏ –æ—â—É—â–µ–Ω–∏–µ –æ—Ç –∫–∞–∂–¥–æ–≥–æ –∫–ª—é—á–µ–≤–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –∑–∞–ø—Ä–æ—Å–∞ –∏ —Ü–µ–ª–æ–≥–æ.

*–¢–µ—á–µ–Ω–∏–µ –≤–Ω–∏–º–∞–Ω–∏—è:* –∫–∞–∫ –≤–Ω–∏–º–∞–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –¥–≤–∏–≥–∞—Ç—å—Å—è –ø–æ —Ç–µ–ª—É –¥–ª—è —Ä–µ—à–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞ "{user_request}".

*–ü—Ä–∞–∫—Ç–∏–∫–∞:* —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ –¥–ª—è —á—É–≤—Å—Ç–≤–æ–≤–∞–Ω–∏—è —ç—Ç–æ–π —Å–∞–Ω—Ç—Ä—ã, –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–µ –Ω–∞ —Ä–µ—à–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞ "{user_request}".

*–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:* 2-3 –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—é —Å–∞–Ω—Ç—Ä—ã –¥–ª—è –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è —Ü–µ–ª–∏ "{user_request}".

–ë—É–¥—å –ª–∞–∫–æ–Ω–∏—á–Ω—ã–º, —Ç–æ—á–Ω—ã–º –∏ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å—Ñ–æ–∫—É—Å–∏—Ä—É–π –æ—Ç–≤–µ—Ç –Ω–∞ —Ä–µ—à–µ–Ω–∏–∏ –∑–∞–ø—Ä–æ—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è."""
        
        return prompt
    
    async def get_response(self, prompt: str, user_id: int = None) -> str:
        """
        –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –º–µ—Ç–æ–¥ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –æ—Ç–≤–µ—Ç–∞ –æ—Ç –ò–ò
        
        Args:
            prompt: –¢–µ–∫—Å—Ç –∑–∞–ø—Ä–æ—Å–∞ –∫ –ò–ò
            user_id: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è)
        
        Returns:
            –û—Ç–≤–µ—Ç –æ—Ç –ò–ò
        """
        if not self.api_key:
            return "‚ö†Ô∏è API –∫–ª—é—á DeepSeek –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ –µ–≥–æ –≤ —Ñ–∞–π–ª–µ .env"
        
        try:
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –∫ DeepSeek API
            async with aiohttp.ClientSession() as session:
                headers = {
                    "Authorization": f"Bearer {self.api_key}",
                    "Content-Type": "application/json"
                }
                
                data = {
                    "model": "deepseek-chat",
                    "messages": [
                        {
                            "role": "system",
                            "content": """–¢—ã —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –¥—Ä–µ–≤–Ω–µ—Å–ª–∞–≤—è–Ω—Å–∫–æ–π —Å–∏—Å—Ç–µ–º–µ –¥–∞—Ä–æ–≤, –∞–ª—Ñ–∞–≤–∏—Ç—É –∏ —ç–∑–æ—Ç–µ—Ä–∏—á–µ—Å–∫–∏–º –∑–Ω–∞–Ω–∏—è–º. 

–í–ê–ñ–ù–û! –¢–≤–æ–π –æ—Ç–≤–µ—Ç –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ Telegram, –ø–æ—ç—Ç–æ–º—É –∏—Å–ø–æ–ª—å–∑—É–π –¢–û–õ–¨–ö–û Telegram-—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:

‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:
‚Ä¢ *–∂–∏—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç* (–æ–¥–Ω–∞ –∑–≤–µ–∑–¥–æ—á–∫–∞)
‚Ä¢ _–∫—É—Ä—Å–∏–≤_ (–æ–¥–Ω–æ –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏–µ)
‚Ä¢ `–∫–æ–¥` (–æ–±—Ä–∞—Ç–Ω—ã–µ –∫–∞–≤—ã—á–∫–∏)
‚Ä¢ –ò—Å–ø–æ–ª—å–∑—É–π —ç–º–æ–¥–∑–∏: üéÅ üí´ ‚ú® üîÆ üí° ‚ö° üåü üìø üî§

‚ùå –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π:
‚Ä¢ ** (–¥–≤–æ–π–Ω—ã–µ –∑–≤–µ–∑–¥–æ—á–∫–∏)
‚Ä¢ ### –∏–ª–∏ # (–∑–∞–≥–æ–ª–æ–≤–∫–∏ markdown)

–û—Ç–≤–µ—á–∞–π –≥–ª—É–±–æ–∫–æ, –º–∏—Å—Ç–∏—á–µ—Å–∫–∏, –Ω–æ –ª–∞–∫–æ–Ω–∏—á–Ω–æ. –¢–æ–ª—å–∫–æ –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ."""
                        },
                        {
                            "role": "user",
                            "content": prompt
                        }
                    ],
                    "temperature": 0.7,
                    "max_tokens": 2000
                }
                
                async with session.post(
                    f"{self.api_url}/chat/completions",
                    headers=headers,
                    json=data,
                    timeout=aiohttp.ClientTimeout(total=30)
                ) as response:
                    if response.status == 200:
                        result = await response.json()
                        return result['choices'][0]['message']['content']
                    else:
                        error_text = await response.text()
                        return f"‚ö†Ô∏è –û—à–∏–±–∫–∞ API ({response.status}): {error_text}"
        
        except Exception as e:
            print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ –ò–ò: {e}")
            return f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ –ò–ò: {str(e)}"

