"""
–ú–æ–¥—É–ª—å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ò–ò (DeepSeek API)
–ê–Ω–∞–ª–∏–∑ –¥–∞—Ä–æ–≤ –∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç—Ä–∞–∫—Ç–æ–≤–æ–∫
"""
import aiohttp
from src.config import Config
from src.database import Database
from src.gifts_knowledge import get_gift_info, get_gifts_by_kun, format_gift_description, format_multiple_gifts

class AIHandler:
    """–ö–ª–∞—Å—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ò–ò"""
    
    def __init__(self):
        self.api_key = Config.DEEPSEEK_API_KEY
        self.api_url = Config.DEEPSEEK_API_URL
        self.db = Database()
        
        # –õ–æ–≥–∏—Ä—É–µ–º —Å—Ç–∞—Ç—É—Å API –∫–ª—é—á–∞ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
        if self.api_key:
            print(f"‚úÖ AIHandler –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω —Å API –∫–ª—é—á–æ–º (–¥–ª–∏–Ω–∞: {len(self.api_key)} —Å–∏–º–≤–æ–ª–æ–≤)")
        else:
            print("‚ö†Ô∏è AIHandler –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω –ë–ï–ó API –∫–ª—é—á–∞ - –±—É–¥—É—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –±–∞–∑–æ–≤—ã–µ –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏–∏")
    
    async def get_gift_interpretation(self, gift_data: dict, user_context: str = "") -> str:
        """
        –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç—Ä–∞–∫—Ç–æ–≤–∫–∏ –¥–∞—Ä–∞ –æ—Ç –ò–ò –Ω–∞ –æ—Å–Ω–æ–≤–µ –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π
        
        Args:
            gift_data: –î–∞–Ω–Ω—ã–µ –æ —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–Ω—ã—Ö –¥–∞—Ä–∞—Ö (—Å–æ–¥–µ—Ä–∂–∏—Ç gift_code –≤ —Ñ–æ—Ä–º–∞—Ç–µ "–º–∞-–∂–∏-–∫—É–Ω")
            user_context: –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
        
        Returns:
            –¢—Ä–∞–∫—Ç–æ–≤–∫–∞ –æ—Ç –ò–ò
        """
        if not self.api_key:
            return self._get_basic_interpretation(gift_data)
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º –∑–∞–ø—Ä–æ—Å –∫ –ò–ò
        prompt = self._build_prompt(gift_data, user_context)
        
        try:
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –∫ DeepSeek API
            async with aiohttp.ClientSession() as session:
                headers = {
                    "Authorization": f"Bearer {self.api_key}",
                    "Content-Type": "application/json"
                }
                
                data = {
                    "model": "deepseek-chat",
                    "messages": [
                        {
                            "role": "system",
                            "content": """–¢—ã —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –¥—Ä–µ–≤–Ω–µ—Å–ª–∞–≤—è–Ω—Å–∫–æ–π —Å–∏—Å—Ç–µ–º–µ –¥–∞—Ä–æ–≤ —Ä–æ–∂–¥–µ–Ω–∏—è –ú–∞-–ñ–∏-–ö—É–Ω. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ - –¥–∞–≤–∞—Ç—å –≥–ª—É–±–æ–∫–∏–µ, —Ç–æ—á–Ω—ã–µ –∏ –ª–∞–∫–æ–Ω–∏—á–Ω—ã–µ —Ç—Ä–∞–∫—Ç–æ–≤–∫–∏ –¥–∞—Ä–æ–≤ —á–µ–ª–æ–≤–µ–∫–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–∞—Å—á–µ—Ç–æ–≤ –ø–æ –¥–∞—Ç–µ —Ä–æ–∂–¥–µ–Ω–∏—è.

–í–ê–ñ–ù–û! –¢–≤–æ–π –æ—Ç–≤–µ—Ç –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ Telegram, –ø–æ—ç—Ç–æ–º—É –∏—Å–ø–æ–ª—å–∑—É–π –¢–û–õ–¨–ö–û Telegram-—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:

‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è Telegram:
‚Ä¢ *–∂–∏—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç* (–æ–¥–Ω–∞ –∑–≤–µ–∑–¥–æ—á–∫–∞ —Å –∫–∞–∂–¥–æ–π —Å—Ç–æ—Ä–æ–Ω—ã)
‚Ä¢ _–∫—É—Ä—Å–∏–≤_ (–æ–¥–Ω–æ –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏–µ)
‚Ä¢ `–∫–æ–¥ –∏–ª–∏ —Ü–∏—Ç–∞—Ç–∞` (–æ–±—Ä–∞—Ç–Ω—ã–µ –∫–∞–≤—ã—á–∫–∏)
‚Ä¢ –ò—Å–ø–æ–ª—å–∑—É–π —ç–º–æ–¥–∑–∏ –¥–ª—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã: üéÅ üí´ ‚ú® üîÆ üí° ‚ö° üåü
‚Ä¢ –†–∞–∑–¥–µ–ª—è–π —Ä–∞–∑–¥–µ–ª—ã –ø—É—Å—Ç—ã–º–∏ —Å—Ç—Ä–æ–∫–∞–º–∏ –¥–ª—è —á–∏—Ç–∞–µ–º–æ—Å—Ç–∏

‚ùå –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π:
‚Ä¢ ** (–¥–≤–æ–π–Ω—ã–µ –∑–≤–µ–∑–¥–æ—á–∫–∏)
‚Ä¢ ### –∏–ª–∏ # (–∑–∞–≥–æ–ª–æ–≤–∫–∏ markdown)
‚Ä¢ –î—Ä—É–≥–∏–µ markdown-—Å–∏–º–≤–æ–ª—ã, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ —Ä–∞–±–æ—Ç–∞—é—Ç –≤ Telegram

–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ—Ç–≤–µ—Ç–∞:
1. –ö—Ä–∞—Ç–∫–æ–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ —Å —ç–º–æ–¥–∑–∏
2. –ó–Ω–∞—á–µ–Ω–∏–µ –¥–∞—Ä–∞ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º *–∂–∏—Ä–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞*
3. –°–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã (—Å —ç–º–æ–¥–∑–∏)
4. –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ (—Å —ç–º–æ–¥–∑–∏)
5. –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–û—Ç–≤–µ—á–∞–π —Ç–æ–ª—å–∫–æ –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ. –ë—É–¥—å –≥–ª—É–±–æ–∫–∏–º, –Ω–æ –ª–∞–∫–æ–Ω–∏—á–Ω—ã–º."""
                        },
                        {
                            "role": "user",
                            "content": prompt
                        }
                    ],
                    "temperature": 0.7,
                    "max_tokens": 2000
                }
                
                async with session.post(
                    f"{self.api_url}/chat/completions",
                    headers=headers,
                    json=data
                ) as response:
                    if response.status == 200:
                        result = await response.json()
                        return result['choices'][0]['message']['content']
                    else:
                        return self._get_basic_interpretation(gift_data)
        
        except Exception as e:
            print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ –ò–ò: {e}")
            return self._get_basic_interpretation(gift_data)
    
    def _build_prompt(self, gift_data: dict, user_context: str) -> str:
        """–ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –ø—Ä–æ–º–ø—Ç–∞ –¥–ª—è –ò–ò"""
        gift_code = gift_data.get('gift_code', '')
        birth_date = gift_data.get('birth_date', '')
        ma = gift_data.get('ma', 0)
        ji = gift_data.get('ji', 0)
        kun = gift_data.get('kun', 0)
        
        # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –¥–∞—Ä–µ –∏–∑ –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π
        gift_info = get_gift_info(gift_code)
        
        prompt = f"""–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –¥–∞—Ä —á–µ–ª–æ–≤–µ–∫–∞ –ø–æ –¥–∞—Ç–µ —Ä–æ–∂–¥–µ–Ω–∏—è {birth_date}:

üî¢ –†–∞—Å—á–µ—Ç –ø–æ —Å–∏—Å—Ç–µ–º–µ –ú–∞-–ñ–∏-–ö—É–Ω:
‚Ä¢ –ú–∞ (–¥–µ–Ω—å+–º–µ—Å—è—Ü): {ma}
‚Ä¢ –ñ–∏ (–≥–æ–¥): {ji}  
‚Ä¢ –ö—É–Ω (–º–∞+–∂–∏): {kun}
‚Ä¢ –ö–æ–¥ –¥–∞—Ä–∞: {gift_code}

"""
        
        # –ï—Å–ª–∏ –¥–∞—Ä –Ω–∞–π–¥–µ–Ω –≤ –±–∞–∑–µ, –¥–æ–±–∞–≤–ª—è–µ–º –µ–≥–æ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
        if gift_info:
            prompt += f"""üìö –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –¥–∞—Ä–µ –∏–∑ –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π:
‚Ä¢ –ù–∞–∑–≤–∞–Ω–∏–µ: {gift_info.get('name', '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ')}
‚Ä¢ –û–ø–∏—Å–∞–Ω–∏–µ: {gift_info.get('description', '–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è')}

"""
        else:
            # –ï—Å–ª–∏ —Ç–æ—á–Ω–æ–≥–æ –¥–∞—Ä–∞ –Ω–µ—Ç, –∏—â–µ–º –¥–∞—Ä—ã —Å —Ç–∞–∫–∏–º –∂–µ –∫—É–Ω
            kun_gifts = get_gifts_by_kun(kun)
            if kun_gifts:
                prompt += f"üìö –¢–æ—á–Ω–æ–≥–æ –¥–∞—Ä–∞ {gift_code} –Ω–µ –Ω–∞–π–¥–µ–Ω–æ, –Ω–æ –µ—Å—Ç—å –¥–∞—Ä—ã —Å —Ç–∞–∫–∏–º –∂–µ –ö—É–Ω ({kun}):\n\n"
                for kg in kun_gifts[:3]:  # –ë–µ—Ä–µ–º –ø–µ—Ä–≤—ã–µ 3 –¥–∞—Ä–∞
                    prompt += f"‚Ä¢ {kg.get('name', '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ')} ({kg.get('code', '')})\n"
                    prompt += f"  {kg.get('description', '')[:100]}...\n\n"
        
        if user_context:
            prompt += f"–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç: {user_context}\n\n"
        
        prompt += """–ù–∞ –æ—Å–Ω–æ–≤–µ —ç—Ç–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –¥–∞–π –ø–æ–ª–Ω—É—é —Ç—Ä–∞–∫—Ç–æ–≤–∫—É –¥–∞—Ä–∞:
1. –ó–Ω–∞—á–µ–Ω–∏–µ –¥–∞—Ä–∞ –∏ –µ–≥–æ —ç–Ω–µ—Ä–≥–µ—Ç–∏–∫–∞
2. –°–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã –∏ —Ç–∞–ª–∞–Ω—Ç—ã
3. –ñ–∏–∑–Ω–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏ –∏ –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ
4. –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —Ä–∞—Å–∫—Ä—ã—Ç–∏—é –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª–∞

–û—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≥–ª—É–±–æ–∫–∏–º, —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –∏ –ø—Ä–∞–∫—Ç–∏—á–Ω—ã–º."""
        
        return prompt
    
    def _get_basic_interpretation(self, gift_data: dict) -> str:
        """–ë–∞–∑–æ–≤–∞—è —Ç—Ä–∞–∫—Ç–æ–≤–∫–∞ –±–µ–∑ –ò–ò (—Ä–µ–∑–µ—Ä–≤–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç) - —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è Telegram"""
        birth_date = gift_data.get('birth_date', '')
        gift_code = gift_data.get('gift_code', '')
        ma = gift_data.get('ma', 0)
        ji = gift_data.get('ji', 0)
        kun = gift_data.get('kun', 0)
        
        result = f"üîÆ *–ê–Ω–∞–ª–∏–∑ –¥–∞—Ä–∞ –ø–æ –¥–∞—Ç–µ —Ä–æ–∂–¥–µ–Ω–∏—è {birth_date}*\n\n"
        
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–∞—Å—á–µ—Ç—ã
        if 'calculation_details' in gift_data:
            result += "üî¢ *–†–∞—Å—á–µ—Ç:*\n"
            result += f"‚Ä¢ {gift_data['calculation_details']['ma']}\n"
            result += f"‚Ä¢ {gift_data['calculation_details']['ji']}\n"
            result += f"‚Ä¢ {gift_data['calculation_details']['kun']}\n\n"
        
        result += f"üéÅ *–í–∞—à –¥–∞—Ä: {gift_code}*\n\n"
        
        # –ü—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ –¥–∞—Ä –≤ –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π
        gift_info = get_gift_info(gift_code)
        
        if gift_info:
            # –ï—Å–ª–∏ –¥–∞—Ä –Ω–∞–π–¥–µ–Ω - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–ª–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é (—Å Telegram —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º)
            result += self._format_gift_for_telegram(gift_info, gift_code)
        else:
            # –ï—Å–ª–∏ —Ç–æ—á–Ω–æ–≥–æ –¥–∞—Ä–∞ –Ω–µ—Ç - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–∞—Ä—ã —Å —Ç–∞–∫–∏–º –∂–µ –∫—É–Ω
            result += f"‚ö†Ô∏è _–¢–æ—á–Ω–æ–≥–æ –¥–∞—Ä–∞ —Å –∫–æ–¥–æ–º {gift_code} –Ω–µ—Ç –≤ –±–∞–∑–µ._\n\n"
            kun_gifts = get_gifts_by_kun(kun)
            
            if kun_gifts:
                result += self._format_multiple_gifts_for_telegram(kun_gifts, kun)
            else:
                result += f"‚ùå –î–∞—Ä–æ–≤ —Å –ö—É–Ω = {kun} –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –≤ –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π.\n\n"
        
        if not self.api_key:
            result += "\n\n‚ö†Ô∏è *API –∫–ª—é—á DeepSeek –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω!*\n"
            result += "üí° _–î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–ª–Ω–æ–π –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–π —Ç—Ä–∞–∫—Ç–æ–≤–∫–∏ —Å –∞–Ω–∞–ª–∏–∑–æ–º –ò–ò –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É._"
        
        return result
    
    def _format_gift_for_telegram(self, gift_info: dict, gift_code: str) -> str:
        """–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞—Ä–∞ –¥–ª—è Telegram"""
        result = f"‚ú® *{gift_info.get('name', '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è')}*\n\n"
        
        if gift_info.get('ma_ji_kun'):
            result += f"üî¢ {gift_info['ma_ji_kun']}\n\n"
        
        if gift_info.get('description'):
            result += f"üìñ {gift_info['description']}\n\n"
        
        if gift_info.get('image_url'):
            result += f"üñº [–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–∞—Ä–∞]({gift_info['image_url']})\n\n"
        
        if gift_info.get('getgems_url'):
            result += f"üíé [NFT –∫–æ–ª–ª–µ–∫—Ü–∏—è]({gift_info['getgems_url']})\n"
        
        return result
    
    def _format_multiple_gifts_for_telegram(self, kun_gifts: list, kun: int) -> str:
        """–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –¥–∞—Ä–æ–≤ –¥–ª—è Telegram"""
        result = f"üîç *–ù–∞–π–¥–µ–Ω–æ {len(kun_gifts)} –¥–∞—Ä–æ–≤ —Å –ö—É–Ω = {kun}:*\n\n"
        
        for i, gift in enumerate(kun_gifts[:3], 1):  # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–≤—ã–µ 3
            result += f"{i}. ‚ú® *{gift.get('name', '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è')}*\n"
            result += f"   _–ö–æ–¥: {gift.get('code', '')}_\n"
            
            desc = gift.get('description', '')
            if len(desc) > 120:
                desc = desc[:120] + "..."
            result += f"   {desc}\n\n"
        
        if len(kun_gifts) > 3:
            result += f"_–ò –µ—â—ë {len(kun_gifts) - 3} –¥–∞—Ä–æ–≤..._\n\n"
        
        return result
    
    # ============= –ö–û–ú–ü–õ–ï–ö–°–ù–´–ô –ê–ù–ê–õ–ò–ó –í–°–ï–• –î–ê–†–û–í =============
    
    async def get_complete_profile_interpretation(self, profile_data: dict) -> str:
        """
        –ö–æ–º–ø–ª–µ–∫—Å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –≤—Å–µ—Ö —á–µ—Ç—ã—Ä–µ—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ (–û–¥–∞, –¢—É–Ω–∞, –¢—Ä–∏–∞, –ß–∏–∞)
        
        –ü—Ä–æ—Ü–µ—Å—Å:
        1. –î–∞–Ω–Ω—ã–µ –ø—Ä–æ–ø—É—Å–∫–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö (—É–∂–µ —Å–¥–µ–ª–∞–Ω–æ –≤ calculate_complete_profile)
        2. –§–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è –ø—Ä–æ–º–ø—Ç —Å –¥–∞–Ω–Ω—ã–º–∏ –∏–∑ –±–∞–∑—ã
        3. –ò–ò –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Å —É—á–µ—Ç–æ–º –¥–∞–Ω–Ω—ã—Ö –∏–∑ –ë–î
        4. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –∫—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ (1-2-3 —Å–ª–æ–≤–∞) + –¥–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑
        
        Args:
            profile_data: –°–ª–æ–≤–∞—Ä—å —Å —Ä–∞—Å—á–µ—Ç–∞–º–∏ –≤—Å–µ—Ö –¥–∞—Ä–æ–≤ –∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
        
        Returns:
            –ü–æ–ª–Ω–∞—è —Ç—Ä–∞–∫—Ç–æ–≤–∫–∞ –æ—Ç –ò–ò —Å –∫—Ä–∞—Ç–∫–∏–º –æ–ø–∏—Å–∞–Ω–∏–µ–º –∏ –¥–µ—Ç–∞–ª—å–Ω—ã–º –∞–Ω–∞–ª–∏–∑–æ–º
        """
        print("=" * 60)
        print("üé≠ –ö–û–ú–ü–õ–ï–ö–°–ù–´–ô –ê–ù–ê–õ–ò–ó –ü–†–û–§–ò–õ–Ø")
        print("=" * 60)
        print(f"üîç API –∫–ª—é—á: {'‚úÖ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω' if self.api_key else '‚ùå –ù–ï —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω'}")
        print(f"üîç API URL: {self.api_url}")
        
        if not self.api_key:
            print("‚ö†Ô∏è API –∫–ª—é—á –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω, –≤–æ–∑–≤—Ä–∞—â–∞—é –±–∞–∑–æ–≤—É—é —Ç—Ä–∞–∫—Ç–æ–≤–∫—É")
            return self._get_basic_complete_interpretation(profile_data)
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–ª—É—á–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
        print("\nüìä –ü–æ–ª—É—á–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:")
        print(f"   –û–î–ê: {profile_data.get('oda', {}).get('gift_code', '–ù–ï–¢')}")
        print(f"   –¢–£–ù–ê: {profile_data.get('tuna', {}).get('gift_code', '–ù–ï–¢')}")
        print(f"   –¢–†–ò–ê: {profile_data.get('tria', {}).get('gift_code', '–ù–ï–¢')}")
        print(f"   –ß–ò–ê: {profile_data.get('chia', {}).get('gift_code', '–ù–ï–¢')}")
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º –∑–∞–ø—Ä–æ—Å –∫ –ò–ò
        print("\nüìù –§–æ—Ä–º–∏—Ä—É—é –ø—Ä–æ–º–ø—Ç –¥–ª—è –ò–ò...")
        prompt = self._build_complete_prompt(profile_data)
        print(f"‚úÖ –ü—Ä–æ–º–ø—Ç —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω (–¥–ª–∏–Ω–∞: {len(prompt)} —Å–∏–º–≤–æ–ª–æ–≤)")
        print(f"üìù –ü–µ—Ä–≤—ã–µ 200 —Å–∏–º–≤–æ–ª–æ–≤ –ø—Ä–æ–º–ø—Ç–∞:\n{prompt[:200]}...")
        
        try:
            async with aiohttp.ClientSession() as session:
                headers = {
                    "Authorization": f"Bearer {self.api_key}",
                    "Content-Type": "application/json"
                }
                
                data = {
                    "model": "deepseek-chat",
                    "messages": [
                        {
                            "role": "system",
                            "content": """–¢—ã —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –¥—Ä–µ–≤–Ω–µ—Å–ª–∞–≤—è–Ω—Å–∫–æ–π —Å–∏—Å—Ç–µ–º–µ –¥–∞—Ä–æ–≤ —Ä–æ–∂–¥–µ–Ω–∏—è –ú–∞-–ñ–∏-–ö—É–Ω. 

–¢–≤–æ—è –∑–∞–¥–∞—á–∞ - –¥–∞—Ç—å –ì–õ–£–ë–û–ö–ò–ô –∏ –î–ï–¢–ê–õ–¨–ù–´–ô –∫–æ–º–ø–ª–µ–∫—Å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ —á–µ–ª–æ–≤–µ–∫–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –ß–ï–¢–´–†–ï–• —Ä–∞—Å—á–µ—Ç–æ–≤:
1. –û–î–ê (–æ—Å–Ω–æ–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ) - –¥–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è - –≥–ª–∞–≤–Ω–æ–µ –≤–ª–∏—è–Ω–∏–µ (100%)
2. –¢–£–ù–ê (–≤—Ç–æ—Ä–æ—Å—Ç–µ–ø–µ–Ω–Ω—ã–µ) - –≤—Ä–µ–º—è —Ä–æ–∂–¥–µ–Ω–∏—è - –º–µ–Ω—å—à–µ–µ –≤–ª–∏—è–Ω–∏–µ (70%)
3. –¢–†–ò–ê (—Ç—Ä–µ—Ç—å–µ—Å—Ç–µ–ø–µ–Ω–Ω—ã–µ) - –º–µ—Å—Ç–æ —Ä–æ–∂–¥–µ–Ω–∏—è - –µ—â–µ –º–µ–Ω—å—à–µ–µ –≤–ª–∏—è–Ω–∏–µ (40%)
4. –ß–ò–ê (—á–µ—Ç–≤–µ—Ä–æ—Å—Ç–µ–ø–µ–Ω–Ω—ã–µ) - –∏–º—è –∏ —Ñ–∞–º–∏–ª–∏—è - —Å–∞–º–æ–µ –º–∞–ª–æ–µ, –Ω–æ –≤–∞–∂–Ω–æ–µ –≤–ª–∏—è–Ω–∏–µ (20%)

–°–¢–†–û–ì–ê–Ø –°–¢–†–£–ö–¢–£–†–ê –û–¢–í–ï–¢–ê (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –°–õ–ï–î–£–ô –≠–¢–û–ú–£ –§–û–†–ú–ê–¢–£):

1. –°–ù–ê–ß–ê–õ–ê - –∫—Ä–∞—Ç–∫–∞—è —Å—É—Ç—å –≤ 1-3 —Å–ª–æ–≤–∞ (–ë–ï–ó —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è, –ø—Ä–æ—Å—Ç–æ —Ç–µ–∫—Å—Ç, –ª–∞–∫–æ–Ω–∏—á–Ω–æ–µ –Ω–∞–∏–±–æ–ª–µ–µ –ø–æ–¥—Ö–æ–¥—è—â–µ–µ –æ–ø–∏—Å–∞–Ω–∏–µ)
–ù–∞–ø—Ä–∏–º–µ—Ä: "–•—Ä–∞–Ω–∏—Ç–µ–ª—å –°–≤–µ—Ç–∞" –∏–ª–∏ "–î—É—Ö–æ–≤–Ω—ã–π –ø—Ä–æ–≤–æ–¥–Ω–∏–∫" –∏–ª–∏ "–¢–≤–æ—Ä–µ—Ü –†–µ–∞–ª—å–Ω–æ—Å—Ç–∏"
–≠—Ç–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —Å–∞–º–æ–µ —Ç–æ—á–Ω–æ–µ –∏ –µ–º–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Å—É—Ç–∏ —á–µ–ª–æ–≤–µ–∫–∞ –≤ 1-3 —Å–ª–æ–≤–∞—Ö.

2. –ó–∞—Ç–µ–º —Ä–∞–∑–¥–µ–ª–∏ –æ–ø–∏—Å–∞–Ω–∏–µ –Ω–∞ —Ä–∞–∑–¥–µ–ª—ã (–õ–ê–ö–û–ù–ò–ß–ù–û, –Ω–æ –ì–õ–£–ë–û–ö–û - —Ç–æ–ª—å–∫–æ –æ—Å–Ω–æ–≤—ã, –ø–µ—Ä–µ–¥–∞—é—â–∏–µ —Å—É—Ç—å):

*–û–î–ê - –û—Å–Ω–æ–≤–∞ –ª–∏—á–Ω–æ—Å—Ç–∏* üéÅ
–ö–æ–¥ [–∫–æ–¥ –¥–∞—Ä–∞]
[–õ–ê–ö–û–ù–ò–ß–ù–´–ô, –Ω–æ –ì–õ–£–ë–û–ö–ò–ô –∞–Ω–∞–ª–∏–∑ –≥–ª–∞–≤–Ω–æ–≥–æ –¥–∞—Ä–∞ - —Ç–æ–ª—å–∫–æ –æ—Å–Ω–æ–≤—ã, –ø–µ—Ä–µ–¥–∞—é—â–∏–µ —Å—É—Ç—å. –ß—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç –¥–∞—Ä, –∫–∞–∫ –ø—Ä–æ—è–≤–ª—è–µ—Ç—Å—è –≤ –∂–∏–∑–Ω–∏, –∫–ª—é—á–µ–≤—ã–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏. 2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è, –Ω–æ –≥–ª—É–±–æ–∫–æ –ø–µ—Ä–µ–¥–∞—é—â–∏–µ —Å—É—Ç—å. –û–ø–∏—Ä–∞–π—Å—è –Ω–∞ –æ–ø–∏—Å–∞–Ω–∏–µ –∏–∑ –±–∞–∑—ã, –Ω–æ –±—É–¥—å –ª–∞–∫–æ–Ω–∏—á–Ω—ã–º.]

*–¢–£–ù–ê - –í—Ä–µ–º–µ–Ω–Ω–æ–π –∞—Å–ø–µ–∫—Ç* üåô
–ö–æ–¥ [–∫–æ–¥ –¥–∞—Ä–∞]. –î–∞—Ä [–Ω–∞–∑–≤–∞–Ω–∏–µ –¥–∞—Ä–∞].
[–õ–ê–ö–û–ù–ò–ß–ù–´–ô –∞–Ω–∞–ª–∏–∑ –∫–∞–∫ –≤—Ä–µ–º—è —Ä–æ–∂–¥–µ–Ω–∏—è –≤–ª–∏—è–µ—Ç –Ω–∞ —Ö–∞—Ä–∞–∫—Ç–µ—Ä, —á—Ç–æ –¥–æ–±–∞–≤–ª—è–µ—Ç —ç—Ç–æ—Ç –∞—Å–ø–µ–∫—Ç –∫ –æ—Å–Ω–æ–≤–Ω–æ–º—É –¥–∞—Ä—É. 2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è, —Ç–æ–ª—å–∫–æ –æ—Å–Ω–æ–≤—ã, –Ω–æ –≥–ª—É–±–æ–∫–æ –ø–µ—Ä–µ–¥–∞—é—â–∏–µ —Å—É—Ç—å.]

*–¢–†–ò–ê - –≠–Ω–µ—Ä–≥–∏—è –º–µ—Å—Ç–∞* üåç
–ö–æ–¥ [–∫–æ–¥ –¥–∞—Ä–∞]
[–õ–ê–ö–û–ù–ò–ß–ù–´–ô –∞–Ω–∞–ª–∏–∑ –≤–ª–∏—è–Ω–∏—è –º–µ—Å—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è, –∫–∞–∫ –≥–µ–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∞—è —Ç–æ—á–∫–∞ –≤–ª–∏—è–µ—Ç –Ω–∞ —Å—É–¥—å–±—É. 2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è, —Ç–æ–ª—å–∫–æ –æ—Å–Ω–æ–≤—ã, –Ω–æ –≥–ª—É–±–æ–∫–æ –ø–µ—Ä–µ–¥–∞—é—â–∏–µ —Å—É—Ç—å.]

*–ß–ò–ê - –ò–º—è –∏ —Å—É–¥—å–±–∞* üí´
–ö–æ–¥ [–∫–æ–¥ –¥–∞—Ä–∞]. –î–∞—Ä [–Ω–∞–∑–≤–∞–Ω–∏–µ –¥–∞—Ä–∞].
[–õ–ê–ö–û–ù–ò–ß–ù–´–ô –∞–Ω–∞–ª–∏–∑ –≤–ª–∏—è–Ω–∏—è –∏–º–µ–Ω–∏, –∫–∞–∫ –∏–º—è –¥–æ–ø–æ–ª–Ω—è–µ—Ç –æ–±—â—É—é –∫–∞—Ä—Ç–∏–Ω—É. 2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è, —Ç–æ–ª—å–∫–æ –æ—Å–Ω–æ–≤—ã, –Ω–æ –≥–ª—É–±–æ–∫–æ –ø–µ—Ä–µ–¥–∞—é—â–∏–µ —Å—É—Ç—å.]

*–û–±—â–∞—è –∫–∞—Ä—Ç–∏–Ω–∞* üîÆ
[–õ–ê–ö–û–ù–ò–ß–ù–´–ô –∏ –Ø–°–ù–´–ô —Å–∏–Ω—Ç–µ–∑ –≤—Å–µ—Ö –∞—Å–ø–µ–∫—Ç–æ–≤ - –∫–∞–∫ –≤—Å–µ 4 –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤—É—é—Ç, —Å–æ–∑–¥–∞–≤–∞—è –µ–¥–∏–Ω—É—é –∫–∞—Ä—Ç–∏–Ω—É –ª–∏—á–Ω–æ—Å—Ç–∏. –û–±—ä—è—Å–Ω–∏ –≤–∑–∞–∏–º–æ—Å–≤—è–∑–∏ —è—Å–Ω–æ –∏ —á–µ—Ç–∫–æ. 3-4 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è, –Ω–∞ 20% –ª–∞–∫–æ–Ω–∏—á–Ω–µ–µ, –Ω–æ —Å –±–æ–ª–µ–µ —è—Å–Ω–æ–π —Ç—Ä–∞–∫—Ç–æ–≤–∫–æ–π.]

*–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏* ‚ú®
[–ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è —Ä–∞—Å–∫—Ä—ã—Ç–∏—è –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª–∞, –∫–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–≤–æ–∏ –¥–∞—Ä—ã, –Ω–∞ —á—Ç–æ –æ–±—Ä–∞—Ç–∏—Ç—å –≤–Ω–∏–º–∞–Ω–∏–µ. –ú–∏–Ω–∏–º—É–º 3-5 –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö —Å–æ–≤–µ—Ç–æ–≤.]

–í–ê–ñ–ù–û! 
‚Ä¢ –ò—Å–ø–æ–ª—å–∑—É–π –¢–û–õ–¨–ö–û Telegram-—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: *–∂–∏—Ä–Ω—ã–π*, _–∫—É—Ä—Å–∏–≤_, `–∫–æ–¥`
‚Ä¢ –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π ##, ###, ** (–¥–≤–æ–π–Ω—ã–µ –∑–≤–µ–∑–¥–æ—á–∫–∏)
‚Ä¢ –ë—É–¥—å –õ–ê–ö–û–ù–ò–ß–ù–´–ú, –Ω–æ –ì–õ–£–ë–û–ö–ò–ú - —Ç–æ–ª—å–∫–æ –æ—Å–Ω–æ–≤—ã, –Ω–æ –≥–ª—É–±–æ–∫–æ –ø–µ—Ä–µ–¥–∞—é—â–∏–µ —Å—É—Ç—å
‚Ä¢ –û–°–ù–û–í–ù–ê–Ø –û–ü–û–†–ê –Ω–∞ –æ–ø–∏—Å–∞–Ω–∏—è –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö - –∏—Å–ø–æ–ª—å–∑—É–π –∏—Ö –∫–∞–∫ —Ñ—É–Ω–¥–∞–º–µ–Ω—Ç
‚Ä¢ –†–ê–°–®–ò–†–Ø–ô –∏ –ò–ù–¢–ï–†–ü–†–ï–¢–ò–†–£–ô –¥–∞–Ω–Ω—ã–µ –∏–∑ –ë–î, –Ω–æ –Ω–µ —É—Ö–æ–¥–∏ –¥–∞–ª–µ–∫–æ –æ—Ç –Ω–∏—Ö
‚Ä¢ –î–ª—è –û–¥–∞, –¢—É–Ω–∞, –¢—Ä–∏–∞, –ß–∏–∞ - 2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è, —Ç–æ–ª—å–∫–æ –æ—Å–Ω–æ–≤—ã, –Ω–æ –≥–ª—É–±–æ–∫–æ
‚Ä¢ –û–±—â–∞—è –∫–∞—Ä—Ç–∏–Ω–∞ - 3-4 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è, –Ω–∞ 20% –ª–∞–∫–æ–Ω–∏—á–Ω–µ–µ, –Ω–æ —Å –±–æ–ª–µ–µ —è—Å–Ω–æ–π —Ç—Ä–∞–∫—Ç–æ–≤–∫–æ–π
‚Ä¢ –ü–æ–∫–∞–∑—ã–≤–∞–π –∫–∞–∫ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤—É—é—Ç –¥—Ä—É–≥ —Å –¥—Ä—É–≥–æ–º
‚Ä¢ –î–∞–≤–∞–π –ü–†–ê–ö–¢–ò–ß–ï–°–ö–ò–ï —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
‚Ä¢ –ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ (1-3 —Å–ª–æ–≤–∞) –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –ª–∞–∫–æ–Ω–∏—á–Ω—ã–º –∏ —Ç–æ—á–Ω—ã–º - –∫—Ç–æ –µ—Å—Ç—å —ç—Ç–æ—Ç —á–µ–ª–æ–≤–µ–∫"""
                        },
                        {
                            "role": "user",
                            "content": prompt
                        }
                    ],
                    "temperature": 0.8,
                    "max_tokens": 4000
                }
                
                print(f"üåê –û—Ç–ø—Ä–∞–≤–ª—è—é –∑–∞–ø—Ä–æ—Å –∫ API: {self.api_url}/chat/completions")
                print(f"üì§ –†–∞–∑–º–µ—Ä –ø—Ä–æ–º–ø—Ç–∞: {len(prompt)} —Å–∏–º–≤–æ–ª–æ–≤")
                
                async with session.post(
                    f"{self.api_url}/chat/completions",
                    headers=headers,
                    json=data,
                    timeout=aiohttp.ClientTimeout(total=60)
                ) as response:
                    print(f"üì° –ü–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç –æ—Ç API: status={response.status}")
                    
                    if response.status == 200:
                        result = await response.json()
                        
                        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –æ—Ç–≤–µ—Ç–∞
                        if 'choices' not in result or len(result['choices']) == 0:
                            print(f"‚ùå –ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ—Ç–≤–µ—Ç–∞: {result.keys()}")
                            raise ValueError("–ü—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç –æ—Ç –ò–ò")
                        
                        ai_response = result['choices'][0]['message']['content']
                        
                        if not ai_response or len(ai_response.strip()) == 0:
                            print(f"‚ùå –ü—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç –æ—Ç –ò–ò")
                            raise ValueError("–ü—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç –æ—Ç –ò–ò")
                        
                        print(f"‚úÖ –ò–ò –≤–µ—Ä–Ω—É–ª –æ—Ç–≤–µ—Ç (–¥–ª–∏–Ω–∞: {len(ai_response)} —Å–∏–º–≤–æ–ª–æ–≤)")
                        print(f"üìù –ü–µ—Ä–≤—ã–µ 300 —Å–∏–º–≤–æ–ª–æ–≤ –æ—Ç–≤–µ—Ç–∞:\n{ai_response[:300]}...")
                        
                        # –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ —ç—Ç–æ –Ω–µ –±–∞–∑–æ–≤–∞—è —Ç—Ä–∞–∫—Ç–æ–≤–∫–∞
                        if "–ö–æ–º–ø–ª–µ–∫—Å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –¥–∞—Ä–æ–≤" in ai_response and "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ" in ai_response:
                            print(f"‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï: –ò–ò –≤–µ—Ä–Ω—É–ª –±–∞–∑–æ–≤—É—é —Ç—Ä–∞–∫—Ç–æ–≤–∫—É –≤–º–µ—Å—Ç–æ –∞–Ω–∞–ª–∏–∑–∞!")
                            raise ValueError("–ò–ò –≤–µ—Ä–Ω—É–ª –±–∞–∑–æ–≤—É—é —Ç—Ä–∞–∫—Ç–æ–≤–∫—É")
                        
                        return ai_response
                    else:
                        error_text = await response.text()
                        print(f"‚ùå –û—à–∏–±–∫–∞ API: status={response.status}")
                        print(f"üìÑ –¢–µ–ª–æ –æ—Ç–≤–µ—Ç–∞: {error_text[:500]}")
                        
                        # –ù–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –±–∞–∑–æ–≤—É—é —Ç—Ä–∞–∫—Ç–æ–≤–∫—É –ø—Ä–∏ –æ—à–∏–±–∫–µ API - –ª—É—á—à–µ –ø–æ–∫–∞–∑–∞—Ç—å –æ—à–∏–±–∫—É
                        error_msg = f"""‚ùå *–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ –ò–ò*

–°—Ç–∞—Ç—É—Å: {response.status}
–û—à–∏–±–∫–∞: {error_text[:200]}

–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ –∏–ª–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É."""
                        raise Exception(error_msg)
        
        except aiohttp.ClientError as e:
            print(f"‚ùå –û–®–ò–ë–ö–ê –°–û–ï–î–ò–ù–ï–ù–ò–Ø: {type(e).__name__}: {e}")
            import traceback
            traceback.print_exc()
            raise Exception(f"–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å –ò–ò: {str(e)}")
        
        except Exception as e:
            print(f"‚ùå –ò–°–ö–õ–Æ–ß–ï–ù–ò–ï –ø—Ä–∏ –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ –ò–ò: {type(e).__name__}: {e}")
            import traceback
            traceback.print_exc()
            # –ü—Ä–æ–±—Ä–∞—Å—ã–≤–∞–µ–º –∏—Å–∫–ª—é—á–µ–Ω–∏–µ –¥–∞–ª—å—à–µ, —á—Ç–æ–±—ã –≤ src/bot.py –º–æ–∂–Ω–æ –±—ã–ª–æ –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å
            raise
    
    def _build_complete_prompt(self, profile_data: dict) -> str:
        """–ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –ø—Ä–æ–º–ø—Ç–∞ –¥–ª—è –∫–æ–º–ø–ª–µ–∫—Å–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞"""
        oda = profile_data.get('oda', {})
        tuna = profile_data.get('tuna', {})
        tria = profile_data.get('tria', {})
        chia = profile_data.get('chia', {})
        
        prompt = f"""–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –ø–æ–ª–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å —á–µ–ª–æ–≤–µ–∫–∞:

üë§ *–ò–º—è:* {profile_data.get('name', {}).get('first', '')} {profile_data.get('name', {}).get('last', '')}
üìÖ *–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è:* {profile_data.get('birth_date', '')}
üïê *–í—Ä–µ–º—è —Ä–æ–∂–¥–µ–Ω–∏—è:* {profile_data.get('birth_time', '')}
üåç *–ú–µ—Å—Ç–æ —Ä–æ–∂–¥–µ–Ω–∏—è:* {profile_data.get('location', {}).get('latitude', '')}, {profile_data.get('location', {}).get('longitude', '')}

---

üéÅ *–û–î–ê (–û—Å–Ω–æ–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ - –≥–ª–∞–≤–Ω–æ–µ –≤–ª–∏—è–Ω–∏–µ)*
–ö–æ–¥: {oda.get('gift_code', '')}
–ú–∞: {oda.get('ma', 0)}, –ñ–∏: {oda.get('ji', 0)}, –ö—É–Ω: {oda.get('kun', 0)}
"""
        
        # –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –¥–∞—Ä–µ –û–¥–∞ –∏–∑ –±–∞–∑—ã (—É–∂–µ –µ—Å—Ç—å –≤ profile_data)
        oda_gift_info = oda.get('gift_info', {})
        if oda_gift_info:
            prompt += f"–ù–∞–∑–≤–∞–Ω–∏–µ: {oda_gift_info.get('name', '')}\n"
            prompt += f"–û–ø–∏—Å–∞–Ω–∏–µ: {oda_gift_info.get('description', '')}\n"
        else:
            # Fallback –Ω–∞ —Å—Ç–∞—Ä—ã–π —Å–ø–æ—Å–æ–± –µ—Å–ª–∏ –Ω–µ—Ç gift_info
            oda_gift = get_gift_info(oda.get('gift_code', ''))
            if oda_gift:
                prompt += f"–ù–∞–∑–≤–∞–Ω–∏–µ: {oda_gift.get('name', '')}\n"
                prompt += f"–û–ø–∏—Å–∞–Ω–∏–µ: {oda_gift.get('description', '')}\n"
        
        prompt += f"""
---

üåô *–¢–£–ù–ê (–í—Ç–æ—Ä–æ—Å—Ç–µ–ø–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ - –º–µ–Ω—å—à–µ–µ –≤–ª–∏—è–Ω–∏–µ)*
–ö–æ–¥: {tuna.get('gift_code', '')}
–ú–∞: {tuna.get('ma', 0)}, –ñ–∏: {tuna.get('ji', 0)}, –ö—É–Ω: {tuna.get('kun', 0)}
"""
        
        # –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –¥–∞—Ä–µ –¢—É–Ω–∞ –∏–∑ –±–∞–∑—ã
        tuna_gift_info = tuna.get('gift_info', {})
        if tuna_gift_info:
            prompt += f"–ù–∞–∑–≤–∞–Ω–∏–µ: {tuna_gift_info.get('name', '')}\n"
            prompt += f"–û–ø–∏—Å–∞–Ω–∏–µ: {tuna_gift_info.get('description', '')}\n"
        else:
            tuna_gift = get_gift_info(tuna.get('gift_code', ''))
            if tuna_gift:
                prompt += f"–ù–∞–∑–≤–∞–Ω–∏–µ: {tuna_gift.get('name', '')}\n"
                prompt += f"–û–ø–∏—Å–∞–Ω–∏–µ: {tuna_gift.get('description', '')}\n"
        
        prompt += f"""
---

üåç *–¢–†–ò–ê (–¢—Ä–µ—Ç—å–µ—Å—Ç–µ–ø–µ–Ω–Ω—ã–µ - –≤–ª–∏—è–Ω–∏–µ –º–µ—Å—Ç–∞)*
–ö–æ–¥: {tria.get('gift_code', '')}
–ú–∞: {tria.get('ma', 0)}, –ñ–∏: {tria.get('ji', 0)}, –ö—É–Ω: {tria.get('kun', 0)}
"""
        
        # –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –¥–∞—Ä–µ –¢—Ä–∏–∞ –∏–∑ –±–∞–∑—ã
        tria_gift_info = tria.get('gift_info', {})
        if tria_gift_info:
            prompt += f"–ù–∞–∑–≤–∞–Ω–∏–µ: {tria_gift_info.get('name', '')}\n"
            prompt += f"–û–ø–∏—Å–∞–Ω–∏–µ: {tria_gift_info.get('description', '')}\n"
        else:
            tria_gift = get_gift_info(tria.get('gift_code', ''))
            if tria_gift:
                prompt += f"–ù–∞–∑–≤–∞–Ω–∏–µ: {tria_gift.get('name', '')}\n"
                prompt += f"–û–ø–∏—Å–∞–Ω–∏–µ: {tria_gift.get('description', '')}\n"
        
        prompt += f"""
---

üí´ *–ß–ò–ê (–ß–µ—Ç–≤–µ—Ä–æ—Å—Ç–µ–ø–µ–Ω–Ω—ã–µ - –≤–ª–∏—è–Ω–∏–µ –∏–º–µ–Ω–∏)*
–ö–æ–¥: {chia.get('gift_code', '')}
–ú–∞: {chia.get('ma', 0)}, –ñ–∏: {chia.get('ji', 0)}, –ö—É–Ω: {chia.get('kun', 0)}
"""
        
        # –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –¥–∞—Ä–µ –ß–∏–∞ –∏–∑ –±–∞–∑—ã
        chia_gift_info = chia.get('gift_info', {})
        if chia_gift_info:
            prompt += f"–ù–∞–∑–≤–∞–Ω–∏–µ: {chia_gift_info.get('name', '')}\n"
            prompt += f"–û–ø–∏—Å–∞–Ω–∏–µ: {chia_gift_info.get('description', '')}\n"
        else:
            chia_gift = get_gift_info(chia.get('gift_code', ''))
            if chia_gift:
                prompt += f"–ù–∞–∑–≤–∞–Ω–∏–µ: {chia_gift.get('name', '')}\n"
                prompt += f"–û–ø–∏—Å–∞–Ω–∏–µ: {chia_gift.get('description', '')}\n"
        
        prompt += """
---

–ó–ê–î–ê–ß–ê: –î–∞–π –ì–õ–£–ë–û–ö–ò–ô –∏ –î–ï–¢–ê–õ–¨–ù–´–ô –∫–æ–º–ø–ª–µ–∫—Å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ —ç—Ç–æ–≥–æ —á–µ–ª–æ–≤–µ–∫–∞.

–í–ê–ñ–ù–û:
- –û–¥–∞ –∏–º–µ–µ—Ç –≥–ª–∞–≤–Ω–æ–µ –≤–ª–∏—è–Ω–∏–µ (100%) - —ç—Ç–æ –æ—Å–Ω–æ–≤–∞ –ª–∏—á–Ω–æ—Å—Ç–∏
- –¢—É–Ω–∞ –¥–æ–ø–æ–ª–Ω—è–µ—Ç –û–¥–∞ (70% –≤–ª–∏—è–Ω–∏—è) - –≤—Ä–µ–º–µ–Ω–Ω–æ–π –∞—Å–ø–µ–∫—Ç
- –¢—Ä–∏–∞ –¥–æ–±–∞–≤–ª—è–µ—Ç —Ä–µ–≥–∏–æ–Ω–∞–ª—å–Ω—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ (40% –≤–ª–∏—è–Ω–∏—è)
- –ß–∏–∞ –¥–∞–µ—Ç —Ç–æ–Ω–∫—É—é –Ω–∞—Å—Ç—Ä–æ–π–∫—É —á–µ—Ä–µ–∑ –∏–º—è (20% –≤–ª–∏—è–Ω–∏—è)

–¢–†–ï–ë–û–í–ê–ù–ò–Ø –ö –ê–ù–ê–õ–ò–ó–£:
1. –°–ù–ê–ß–ê–õ–ê –¥–∞–π –∫—Ä–∞—Ç–∫—É—é —Å—É—Ç—å –≤ 1-3 —Å–ª–æ–≤–∞ (–ë–ï–ó —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è) - –ª–∞–∫–æ–Ω–∏—á–Ω–æ–µ –Ω–∞–∏–±–æ–ª–µ–µ –ø–æ–¥—Ö–æ–¥—è—â–µ–µ –æ–ø–∏—Å–∞–Ω–∏–µ, –∫—Ç–æ –µ—Å—Ç—å —ç—Ç–æ—Ç —á–µ–ª–æ–≤–µ–∫
2. –î–ª—è –∫–∞–∂–¥–æ–≥–æ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ (–û–î–ê, –¢–£–ù–ê, –¢–†–ò–ê, –ß–ò–ê) –¥–∞–π –õ–ê–ö–û–ù–ò–ß–ù–´–ô, –Ω–æ –ì–õ–£–ë–û–ö–ò–ô –∞–Ω–∞–ª–∏–∑:
   - –û–°–ù–û–í–ù–ê–Ø –û–ü–û–†–ê –Ω–∞ –æ–ø–∏—Å–∞–Ω–∏—è –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö - –∏—Å–ø–æ–ª—å–∑—É–π –∏—Ö –∫–∞–∫ —Ñ—É–Ω–¥–∞–º–µ–Ω—Ç
   - –¢–æ–ª—å–∫–æ –æ—Å–Ω–æ–≤—ã, –Ω–æ –≥–ª—É–±–æ–∫–æ –ø–µ—Ä–µ–¥–∞—é—â–∏–µ —Å—É—Ç—å
   - –ß—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç –¥–∞—Ä, –∫–∞–∫ –ø—Ä–æ—è–≤–ª—è–µ—Ç—Å—è –≤ –∂–∏–∑–Ω–∏, –∫–ª—é—á–µ–≤—ã–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏
   - 2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞, –Ω–æ –≥–ª—É–±–æ–∫–æ –ø–µ—Ä–µ–¥–∞—é—â–∏–µ —Å—É—Ç—å
   - –†–ê–°–®–ò–†–Ø–ô –¥–∞–Ω–Ω—ã–µ –∏–∑ –ë–î, –Ω–æ –Ω–µ —É—Ö–æ–¥–∏ –¥–∞–ª–µ–∫–æ –æ—Ç –Ω–∏—Ö
3. –í —Ä–∞–∑–¥–µ–ª–µ "–û–±—â–∞—è –∫–∞—Ä—Ç–∏–Ω–∞" –ø–æ–∫–∞–∂–∏:
   - –ö–∞–∫ –≤—Å–µ 4 –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤—É—é—Ç
   - –°–æ–∑–¥–∞—é—Ç –ª–∏ –æ–Ω–∏ –≥–∞—Ä–º–æ–Ω–∏—é –∏–ª–∏ –µ—Å—Ç—å –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏—è
   - –ö–∞–∫–∞—è –æ–±—â–∞—è —ç–Ω–µ—Ä–≥–∏—è –ø–æ–ª—É—á–∞–µ—Ç—Å—è
   - 3-4 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è, –Ω–∞ 20% –ª–∞–∫–æ–Ω–∏—á–Ω–µ–µ, –Ω–æ —Å –±–æ–ª–µ–µ —è—Å–Ω–æ–π —Ç—Ä–∞–∫—Ç–æ–≤–∫–æ–π
4. –í —Ä–∞–∑–¥–µ–ª–µ "–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏" –¥–∞–π:
   - –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Å–æ–≤–µ—Ç—ã
   - –ö–∞–∫ —Ä–∞—Å–∫—Ä—ã—Ç—å –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª
   - –ù–∞ —á—Ç–æ –æ–±—Ä–∞—Ç–∏—Ç—å –≤–Ω–∏–º–∞–Ω–∏–µ
   - –ú–∏–Ω–∏–º—É–º 3-5 —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π

–í–ê–ñ–ù–û: –û–°–ù–û–í–ù–ê–Ø –û–ü–û–†–ê –Ω–∞ –¥–∞–Ω–Ω—ã–µ –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö! –ò—Å–ø–æ–ª—å–∑—É–π –∏—Ö –∫–∞–∫ –æ–±—â–∏–π —Å–æ—É—Å - –æ–±—â—É—é –∫–∞—Ä—Ç–∏–Ω—É, –Ω–æ –ø–æ–¥–∞–≤–∞–π —á–µ—Ä–µ–∑ –ò–ò –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—é. –ë—É–¥—å –õ–ê–ö–û–ù–ò–ß–ù–´–ú, –Ω–æ –ì–õ–£–ë–û–ö–ò–ú - —Ç–æ–ª—å–∫–æ –æ—Å–Ω–æ–≤—ã, –Ω–æ –≥–ª—É–±–æ–∫–æ –ø–µ—Ä–µ–¥–∞—é—â–∏–µ —Å—É—Ç—å!"""
        
        return prompt
    
    def _get_basic_complete_interpretation(self, profile_data: dict) -> str:
        """–ë–∞–∑–æ–≤–∞—è –∫–æ–º–ø–ª–µ–∫—Å–Ω–∞—è —Ç—Ä–∞–∫—Ç–æ–≤–∫–∞ –±–µ–∑ –ò–ò"""
        oda = profile_data.get('oda', {})
        tuna = profile_data.get('tuna', {})
        tria = profile_data.get('tria', {})
        chia = profile_data.get('chia', {})
        
        name = profile_data.get('name', {})
        full_name = f"{name.get('first', '')} {name.get('last', '')}"
        
        result = f"üîÆ *–ö–æ–º–ø–ª–µ–∫—Å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –¥–∞—Ä–æ–≤*\n\n"
        result += f"üë§ *–ò–º—è:* {full_name}\n"
        result += f"üìÖ *–î–∞—Ç–∞:* {profile_data.get('birth_date', '')}\n"
        result += f"üïê *–í—Ä–µ–º—è:* {profile_data.get('birth_time', '')}\n\n"
        result += "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n"
        
        # –û–î–ê
        result += "üéÅ *–û–î–ê - –û—Å–Ω–æ–≤–∞ –ª–∏—á–Ω–æ—Å—Ç–∏* (–≥–ª–∞–≤–Ω–æ–µ –≤–ª–∏—è–Ω–∏–µ)\n"
        result += f"–ö–æ–¥: `{oda.get('gift_code', '')}`\n\n"
        oda_gift_info = oda.get('gift_info', {})
        if oda_gift_info:
            result += f"‚ú® *{oda_gift_info.get('name', '')}*\n"
            result += f"{oda_gift_info.get('description', '')}\n\n"
        else:
            oda_gift = get_gift_info(oda.get('gift_code', ''))
            if oda_gift:
                result += f"‚ú® *{oda_gift.get('name', '')}*\n"
                result += f"{oda_gift.get('description', '')}\n\n"
        
        # –¢–£–ù–ê
        result += "üåô *–¢–£–ù–ê - –í—Ä–µ–º–µ–Ω–Ω–æ–π –∞—Å–ø–µ–∫—Ç* (–º–µ–Ω—å—à–µ–µ –≤–ª–∏—è–Ω–∏–µ)\n"
        result += f"–ö–æ–¥: `{tuna.get('gift_code', '')}`\n\n"
        tuna_gift_info = tuna.get('gift_info', {})
        if tuna_gift_info:
            result += f"‚ú® *{tuna_gift_info.get('name', '')}*\n"
            result += f"{tuna_gift_info.get('description', '')[:200]}...\n\n"
        else:
            tuna_gift = get_gift_info(tuna.get('gift_code', ''))
            if tuna_gift:
                result += f"‚ú® *{tuna_gift.get('name', '')}*\n"
                result += f"{tuna_gift.get('description', '')[:200]}...\n\n"
        
        # –¢–†–ò–ê
        result += "üåç *–¢–†–ò–ê - –≠–Ω–µ—Ä–≥–∏—è –º–µ—Å—Ç–∞* (–µ—â–µ –º–µ–Ω—å—à–µ–µ –≤–ª–∏—è–Ω–∏–µ)\n"
        result += f"–ö–æ–¥: `{tria.get('gift_code', '')}`\n\n"
        tria_gift_info = tria.get('gift_info', {})
        if tria_gift_info:
            result += f"‚ú® *{tria_gift_info.get('name', '')}*\n"
            result += f"{tria_gift_info.get('description', '')[:150]}...\n\n"
        else:
            tria_gift = get_gift_info(tria.get('gift_code', ''))
            if tria_gift:
                result += f"‚ú® *{tria_gift.get('name', '')}*\n"
                result += f"{tria_gift.get('description', '')[:150]}...\n\n"
        
        # –ß–ò–ê
        result += "üí´ *–ß–ò–ê - –ò–º—è –∏ —Å—É–¥—å–±–∞* (—Å–∞–º–æ–µ –º–∞–ª–æ–µ –≤–ª–∏—è–Ω–∏–µ)\n"
        result += f"–ö–æ–¥: `{chia.get('gift_code', '')}`\n\n"
        chia_gift_info = chia.get('gift_info', {})
        if chia_gift_info:
            result += f"‚ú® *{chia_gift_info.get('name', '')}*\n"
            result += f"{chia_gift_info.get('description', '')[:150]}...\n\n"
        else:
            chia_gift = get_gift_info(chia.get('gift_code', ''))
            if chia_gift:
                result += f"‚ú® *{chia_gift.get('name', '')}*\n"
                result += f"{chia_gift.get('description', '')[:150]}...\n\n"
        
        if not self.api_key:
            result += "\n‚ö†Ô∏è *API –∫–ª—é—á DeepSeek –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω!*\n"
            result += "üí° _–î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–ª–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ —Å –ò–ò –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É._"
        
        return result
    
    # ============= –ê–ù–ê–õ–ò–ó –°–ê–ù–¢–† =============
    
    async def analyze_mantra(self, mantra_data: dict) -> str:
        """
        –ê–Ω–∞–ª–∏–∑ —Å–∞–Ω—Ç—Ä—ã —á–µ—Ä–µ–∑ –ò–ò –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ –±–∞–∑ –∫–æ–º–∞–Ω–¥ –∏ –¥–∞—Ä–æ–≤
        
        Args:
            mantra_data: –°–ª–æ–≤–∞—Ä—å —Å –¥–∞–Ω–Ω—ã–º–∏ –æ —Å–∞–Ω—Ç—Ä–µ (–∏–∑ parse_mantra –∏–ª–∏ create_mantra)
        
        Returns:
            –ê–Ω–∞–ª–∏–∑ —Å–∞–Ω—Ç—Ä—ã –æ—Ç –ò–ò
        """
        if not self.api_key:
            return self._get_basic_mantra_interpretation(mantra_data)
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º –∑–∞–ø—Ä–æ—Å –∫ –ò–ò
        prompt = self._build_mantra_prompt(mantra_data)
        
        try:
            async with aiohttp.ClientSession() as session:
                headers = {
                    "Authorization": f"Bearer {self.api_key}",
                    "Content-Type": "application/json"
                }
                
                data = {
                    "model": "deepseek-chat",
                    "messages": [
                        {
                            "role": "system",
                            "content": """–¢—ã –¥—É—Ö–æ–≤–Ω—ã–π –º–∞—Å—Ç–µ—Ä –∏ —ç–∫—Å–ø–µ—Ä—Ç –ø–æ —Å–∞–Ω—Ç—Ä–∞–º - –∫–æ–º–±–∏–Ω–∞—Ü–∏—è–º –∫–æ–º–∞–Ω–¥ –∏ –¥–∞—Ä–æ–≤ –∏–∑ –¥—Ä–µ–≤–Ω–µ—Å–ª–∞–≤—è–Ω—Å–∫–æ–π —Å–∏—Å—Ç–µ–º—ã –ú–∞-–ñ–∏-–ö—É–Ω.

–¢–≤–æ—è –∑–∞–¥–∞—á–∞ - –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Å–∞–Ω—Ç—Ä—ã (—ç–ª–µ–º–µ–Ω—Ç—ã –∏ –¥–∞—Ä—ã) –∏ —Å—Ç—Ä–æ–≥–æ —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–≤–µ—Ç –≤ —Å–ª–µ–¥—É—é—â–µ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–µ:

*[–ù–∞–∑–≤–∞–Ω–∏–µ —Å–∞–Ω—Ç—Ä—ã –∂–∏—Ä–Ω—ã–º —à—Ä–∏—Ñ—Ç–æ–º –±–µ–∑ —Å–ª–æ–≤–∞ "–ù–∞–∑–≤–∞–Ω–∏–µ:"]* - 2-3 —Å–ª–æ–≤–∞, –ø–µ—Ä–µ–¥–∞—é—â–∏–µ —Å—É—Ç—å.

*–°–º—ã—Å–ª:* –∫—Ä–∞—Ç–∫–æ, –æ —á—ë–º —ç—Ç–∞ —Å–∞–Ω—Ç—Ä–∞ –∫–∞–∫ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –¥–ª—è –≤–Ω–∏–º–∞–Ω–∏—è –≤ —Ç–µ–ª–µ.

*–†–∞–∑–±–æ—Ä:* –æ–±—ä—è—Å–Ω–∏ —Ä–æ–ª—å –∏ –æ—â—É—â–µ–Ω–∏–µ –æ—Ç –∫–∞–∂–¥–æ–≥–æ –∫–ª—é—á–µ–≤–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ —Ü–µ–ª–æ–≥–æ.

*–¢–µ—á–µ–Ω–∏–µ –≤–Ω–∏–º–∞–Ω–∏—è:* –æ–ø–∏—à–∏ –ø–æ—à–∞–≥–æ–≤–æ, –∫–∞–∫ –≤–Ω–∏–º–∞–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –¥–≤–∏–≥–∞—Ç—å—Å—è –ø–æ —Ç–µ–ª—É, –∏—Å–ø–æ–ª—å–∑—É—è ¬´–Ω–∞—á–∏–Ω–∞—è —Å...¬ª, ¬´–∑–∞—Ç–µ–º...¬ª, ¬´–ø–æ–∑–≤–æ–ª—è—è...¬ª (–±–µ–∑ –Ω—É–º–µ—Ä–æ–≤–∞–Ω–Ω—ã—Ö —à–∞–≥–æ–≤).

*–ü—Ä–∞–∫—Ç–∏–∫–∞:* –¥–∞–π –æ–¥–Ω–æ –ø—Ä–æ—Å—Ç–æ–µ –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ –¥–ª—è –Ω–µ–ø–æ—Å—Ä–µ–¥—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —á—É–≤—Å—Ç–≤–æ–≤–∞–Ω–∏—è —ç—Ç–æ–π —Å–∞–Ω—Ç—Ä—ã –≤ —Ç–µ–ª–µ –∑–¥–µ—Å—å –∏ —Å–µ–π—á–∞—Å.

–í–ê–ñ–ù–û! 
- –ë—É–¥—å –ª–∞–∫–æ–Ω–∏—á–Ω—ã–º, —Ç–æ—á–Ω—ã–º –∏ –æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –Ω–∞ —Ç–µ–ª–µ—Å–Ω–æ–µ –≤–æ—Å–ø—Ä–∏—è—Ç–∏–µ
- –ò—Å–ø–æ–ª—å–∑—É–π –¢–û–õ–¨–ö–û Telegram-—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:
  ‚Ä¢ *–∂–∏—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç* (–æ–¥–Ω–∞ –∑–≤–µ–∑–¥–æ—á–∫–∞)
  ‚Ä¢ _–∫—É—Ä—Å–∏–≤_ (–æ–¥–Ω–æ –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏–µ)
  ‚Ä¢ `–∫–æ–¥` (–æ–±—Ä–∞—Ç–Ω—ã–µ –∫–∞–≤—ã—á–∫–∏)
  ‚Ä¢ –≠–º–æ–¥–∑–∏ –¥–ª—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã
  ‚Ä¢ –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π ## –∏–ª–∏ ### –∏–ª–∏ **
- –û—Ç–≤–µ—á–∞–π —Ç–æ–ª—å–∫–æ –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ
- –û–ø–∏—Ä–∞–π—Å—è –Ω–∞ –∑–Ω–∞—á–µ–Ω–∏—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö, –Ω–æ —Ñ–æ–∫—É—Å–∏—Ä—É–π—Å—è –Ω–∞ —Ç–µ–ª–µ—Å–Ω–æ–º –æ–ø—ã—Ç–µ"""
                        },
                        {
                            "role": "user",
                            "content": prompt
                        }
                    ],
                    "temperature": 0.8,
                    "max_tokens": 2500
                }
                
                async with session.post(
                    f"{self.api_url}/chat/completions",
                    headers=headers,
                    json=data
                ) as response:
                    if response.status == 200:
                        result = await response.json()
                        return result['choices'][0]['message']['content']
                    else:
                        return self._get_basic_mantra_interpretation(mantra_data)
        
        except Exception as e:
            print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ —Å–∞–Ω—Ç—Ä—ã —á–µ—Ä–µ–∑ –ò–ò: {e}")
            return self._get_basic_mantra_interpretation(mantra_data)
    
    def _build_mantra_prompt(self, mantra_data: dict) -> str:
        """–ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –ø—Ä–æ–º–ø—Ç–∞ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Å–∞–Ω—Ç—Ä—ã"""
        mantra_text = mantra_data.get("mantra", "")
        elements = mantra_data.get("elements", [])
        
        prompt = f"""–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Å–∞–Ω—Ç—Ä—É: *{mantra_text}*

–°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å–∞–Ω—Ç—Ä—ã:
"""
        
        for i, elem in enumerate(elements, 1):
            elem_type = elem.get("type", "")
            elem_name = elem.get("name", "")
            elem_desc = elem.get("description", "")
            
            if elem_type == "–∫–æ–º–∞–Ω–¥–∞":
                position = elem.get("position", "")
                prompt += f"\n{i}. *–ö–æ–º–∞–Ω–¥–∞: {elem_name}* (–ø–æ–∑–∏—Ü–∏—è: {position})\n"
                prompt += f"   –û–ø–∏—Å–∞–Ω–∏–µ: {elem_desc}\n"
            elif elem_type == "–¥–∞—Ä":
                code = elem.get("code", "")
                ma_ji_kun = elem.get("ma_ji_kun", "")
                prompt += f"\n{i}. *–î–∞—Ä: {elem_name}*\n"
                if code:
                    prompt += f"   –ö–æ–¥: {code}\n"
                if ma_ji_kun:
                    prompt += f"   {ma_ji_kun}\n"
                prompt += f"   –û–ø–∏—Å–∞–Ω–∏–µ: {elem_desc}\n"
            else:
                prompt += f"\n{i}. *–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç: {elem_name}*\n"
        
        # –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –æ—à–∏–±–∫–∞—Ö, –µ—Å–ª–∏ –µ—Å—Ç—å
        errors = mantra_data.get("errors", [])
        if errors:
            prompt += f"\n‚ö†Ô∏è –û—à–∏–±–∫–∏ –ø—Ä–∏ –ø–∞—Ä—Å–∏–Ω–≥–µ:\n"
            for error in errors:
                prompt += f"   - {error}\n"
        
        prompt += """
---
        
–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Å–∞–Ω—Ç—Ä—ã (—ç–ª–µ–º–µ–Ω—Ç—ã –∏ –¥–∞—Ä—ã) –∏ —Å—Ç—Ä–æ–≥–æ —Å—Ñ–æ—Ä–º–∏—Ä—É–π –æ—Ç–≤–µ—Ç –≤ —Å–ª–µ–¥—É—é—â–µ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–µ:

*[–ù–∞–∑–≤–∞–Ω–∏–µ —Å–∞–Ω—Ç—Ä—ã –∂–∏—Ä–Ω—ã–º —à—Ä–∏—Ñ—Ç–æ–º –±–µ–∑ —Å–ª–æ–≤–∞ "–ù–∞–∑–≤–∞–Ω–∏–µ:"]* - 2-3 —Å–ª–æ–≤–∞, –ø–µ—Ä–µ–¥–∞—é—â–∏–µ —Å—É—Ç—å.

*–°–º—ã—Å–ª:* –∫—Ä–∞—Ç–∫–æ, –æ —á—ë–º —ç—Ç–∞ —Å–∞–Ω—Ç—Ä–∞ –∫–∞–∫ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –¥–ª—è –≤–Ω–∏–º–∞–Ω–∏—è –≤ —Ç–µ–ª–µ.

*–†–∞–∑–±–æ—Ä:* –æ–±—ä—è—Å–Ω–∏ —Ä–æ–ª—å –∏ –æ—â—É—â–µ–Ω–∏–µ –æ—Ç –∫–∞–∂–¥–æ–≥–æ –∫–ª—é—á–µ–≤–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ —Ü–µ–ª–æ–≥–æ.

*–¢–µ—á–µ–Ω–∏–µ –≤–Ω–∏–º–∞–Ω–∏—è:* –æ–ø–∏—à–∏ –ø–æ—à–∞–≥–æ–≤–æ, –∫–∞–∫ –≤–Ω–∏–º–∞–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –¥–≤–∏–≥–∞—Ç—å—Å—è –ø–æ —Ç–µ–ª—É, –∏—Å–ø–æ–ª—å–∑—É—è ¬´–Ω–∞—á–∏–Ω–∞—è —Å...¬ª, ¬´–∑–∞—Ç–µ–º...¬ª, ¬´–ø–æ–∑–≤–æ–ª—è—è...¬ª (–±–µ–∑ –Ω—É–º–µ—Ä–æ–≤–∞–Ω–Ω—ã—Ö —à–∞–≥–æ–≤).

*–ü—Ä–∞–∫—Ç–∏–∫–∞:* –¥–∞–π –æ–¥–Ω–æ –ø—Ä–æ—Å—Ç–æ–µ –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ –¥–ª—è –Ω–µ–ø–æ—Å—Ä–µ–¥—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —á—É–≤—Å—Ç–≤–æ–≤–∞–Ω–∏—è —ç—Ç–æ–π —Å–∞–Ω—Ç—Ä—ã –≤ —Ç–µ–ª–µ –∑–¥–µ—Å—å –∏ —Å–µ–π—á–∞—Å.

–ë—É–¥—å –ª–∞–∫–æ–Ω–∏—á–Ω—ã–º, —Ç–æ—á–Ω—ã–º –∏ –æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –Ω–∞ —Ç–µ–ª–µ—Å–Ω–æ–µ –≤–æ—Å–ø—Ä–∏—è—Ç–∏–µ."""
        
        return prompt
    
    def _get_basic_mantra_interpretation(self, mantra_data: dict) -> str:
        """–ë–∞–∑–æ–≤–∞—è —Ç—Ä–∞–∫—Ç–æ–≤–∫–∞ —Å–∞–Ω—Ç—Ä—ã –±–µ–∑ –ò–ò"""
        mantra_text = mantra_data.get("mantra", "")
        elements = mantra_data.get("elements", [])
        errors = mantra_data.get("errors", [])
        
        result = f"üîÆ *–ê–Ω–∞–ª–∏–∑ —Å–∞–Ω—Ç—Ä—ã*\n\n"
        result += f"üìø *–°–∞–Ω—Ç—Ä–∞:* `{mantra_text}`\n\n"
        result += "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n"
        
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã
        result += "*–≠–ª–µ–º–µ–Ω—Ç—ã —Å–∞–Ω—Ç—Ä—ã:*\n\n"
        
        for i, elem in enumerate(elements, 1):
            elem_type = elem.get("type", "")
            elem_name = elem.get("name", "")
            elem_desc = elem.get("description", "")
            
            if elem_type == "–∫–æ–º–∞–Ω–¥–∞":
                position = elem.get("position", "")
                result += f"{i}. ‚ö° *–ö–æ–º–∞–Ω–¥–∞: {elem_name}*\n"
                result += f"   –ü–æ–∑–∏—Ü–∏—è: _{position}_\n"
                result += f"   {elem_desc}\n\n"
            elif elem_type == "–¥–∞—Ä":
                code = elem.get("code", "")
                ma_ji_kun = elem.get("ma_ji_kun", "")
                result += f"{i}. ‚ú® *–î–∞—Ä: {elem_name}*\n"
                if code:
                    result += f"   –ö–æ–¥: `{code}`\n"
                if ma_ji_kun:
                    result += f"   {ma_ji_kun}\n"
                result += f"   {elem_desc}\n\n"
            else:
                result += f"{i}. ‚ùì *–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç: {elem_name}*\n\n"
        
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫–∏, –µ—Å–ª–∏ –µ—Å—Ç—å
        if errors:
            result += "\n‚ö†Ô∏è *–û—à–∏–±–∫–∏:*\n"
            for error in errors:
                result += f"‚Ä¢ {error}\n"
            result += "\n"
        
        if not self.api_key:
            result += "\n‚ö†Ô∏è *API –∫–ª—é—á DeepSeek –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω!*\n"
            result += "üí° _–î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–ª–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ —Å –ò–ò –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É._"
        
        return result
    
    # ============= –ê–ù–ê–õ–ò–ó –°–ê–ù–¢–† –ü–û –ó–ê–ü–†–û–°–£ =============
    
    async def analyze_mantra_with_request(self, mantra_data: dict, user_request: str) -> str:
        """
        –ê–Ω–∞–ª–∏–∑ —Å–∞–Ω—Ç—Ä—ã —á–µ—Ä–µ–∑ –ò–ò —Å —É—á–µ—Ç–æ–º –∑–∞–ø—Ä–æ—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        
        Args:
            mantra_data: –°–ª–æ–≤–∞—Ä—å —Å –¥–∞–Ω–Ω—ã–º–∏ –æ —Å–∞–Ω—Ç—Ä–µ
            user_request: –ó–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (—Ç–µ–º–∞ –∏–ª–∏ –≤–æ–ø—Ä–æ—Å)
        
        Returns:
            –ê–Ω–∞–ª–∏–∑ —Å–∞–Ω—Ç—Ä—ã –æ—Ç –ò–ò —Å —É—á–µ—Ç–æ–º –∑–∞–ø—Ä–æ—Å–∞
        """
        if not self.api_key:
            return self._get_basic_mantra_interpretation(mantra_data)
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º –∑–∞–ø—Ä–æ—Å –∫ –ò–ò
        prompt = self._build_mantra_request_prompt(mantra_data, user_request)
        
        try:
            async with aiohttp.ClientSession() as session:
                headers = {
                    "Authorization": f"Bearer {self.api_key}",
                    "Content-Type": "application/json"
                }
                
                data = {
                    "model": "deepseek-chat",
                    "messages": [
                        {
                            "role": "system",
                            "content": """–¢—ã –¥—É—Ö–æ–≤–Ω—ã–π –º–∞—Å—Ç–µ—Ä –∏ —ç–∫—Å–ø–µ—Ä—Ç –ø–æ —Å–∞–Ω—Ç—Ä–∞–º - –∫–æ–º–±–∏–Ω–∞—Ü–∏—è–º –∫–æ–º–∞–Ω–¥ –∏ –¥–∞—Ä–æ–≤ –∏–∑ –¥—Ä–µ–≤–Ω–µ—Å–ª–∞–≤—è–Ω—Å–∫–æ–π —Å–∏—Å—Ç–µ–º—ã –ú–∞-–ñ–∏-–ö—É–Ω.

–¢–≤–æ—è –∑–∞–¥–∞—á–∞ - –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—É—é —Å–∞–Ω—Ç—Ä—É –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –∑–∞–ø—Ä–æ—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ —Å—Ç—Ä–æ–≥–æ —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–≤–µ—Ç –≤ —Å–ª–µ–¥—É—é—â–µ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–µ:

*[–ù–∞–∑–≤–∞–Ω–∏–µ —Å–∞–Ω—Ç—Ä—ã –∂–∏—Ä–Ω—ã–º —à—Ä–∏—Ñ—Ç–æ–º –±–µ–∑ —Å–ª–æ–≤–∞ "–ù–∞–∑–≤–∞–Ω–∏–µ:"]* - 2-3 —Å–ª–æ–≤–∞, –ø–µ—Ä–µ–¥–∞—é—â–∏–µ —Å—É—Ç—å –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –∑–∞–ø—Ä–æ—Å–∞.

*–°–º—ã—Å–ª:* –∫—Ä–∞—Ç–∫–æ, –∫–∞–∫ —ç—Ç–∞ —Å–∞–Ω—Ç—Ä–∞ –ø–æ–º–æ–≥–∞–µ—Ç —Ä–µ—à–∏—Ç—å –∑–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –∫–∞–∫ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –¥–ª—è –≤–Ω–∏–º–∞–Ω–∏—è –≤ —Ç–µ–ª–µ.

*–†–∞–∑–±–æ—Ä:* –æ–±—ä—è—Å–Ω–∏ —Ä–æ–ª—å –∏ –æ—â—É—â–µ–Ω–∏–µ –æ—Ç –∫–∞–∂–¥–æ–≥–æ –∫–ª—é—á–µ–≤–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –∑–∞–ø—Ä–æ—Å–∞ –∏ —Ü–µ–ª–æ–≥–æ.

*–¢–µ—á–µ–Ω–∏–µ –≤–Ω–∏–º–∞–Ω–∏—è:* –æ–ø–∏—à–∏ –ø–æ—à–∞–≥–æ–≤–æ, –∫–∞–∫ –≤–Ω–∏–º–∞–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –¥–≤–∏–≥–∞—Ç—å—Å—è –ø–æ —Ç–µ–ª—É –¥–ª—è —Ä–µ—à–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞, –∏—Å–ø–æ–ª—å–∑—É—è ¬´–Ω–∞—á–∏–Ω–∞—è —Å...¬ª, ¬´–∑–∞—Ç–µ–º...¬ª, ¬´–ø–æ–∑–≤–æ–ª—è—è...¬ª (–±–µ–∑ –Ω—É–º–µ—Ä–æ–≤–∞–Ω–Ω—ã—Ö —à–∞–≥–æ–≤).

*–ü—Ä–∞–∫—Ç–∏–∫–∞:* –¥–∞–π –æ–¥–Ω–æ –ø—Ä–æ—Å—Ç–æ–µ –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ –¥–ª—è –Ω–µ–ø–æ—Å—Ä–µ–¥—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —á—É–≤—Å—Ç–≤–æ–≤–∞–Ω–∏—è —ç—Ç–æ–π —Å–∞–Ω—Ç—Ä—ã –≤ —Ç–µ–ª–µ –∑–¥–µ—Å—å –∏ —Å–µ–π—á–∞—Å, —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–µ –Ω–∞ —Ä–µ—à–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

*–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:* –¥–∞–π 2-3 –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏, –∫–∞–∫ –ø—Ä–∏–º–µ–Ω—è—Ç—å —ç—Ç—É —Å–∞–Ω—Ç—Ä—É –¥–ª—è –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è —Ü–µ–ª–∏ –∑–∞–ø—Ä–æ—Å–∞.

–í–ê–ñ–ù–û! 
- –í–µ—Å—å –æ—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Å—Ñ–æ–∫—É—Å–∏—Ä–æ–≤–∞–Ω –Ω–∞ –∑–∞–ø—Ä–æ—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –ë—É–¥—å –ª–∞–∫–æ–Ω–∏—á–Ω—ã–º, —Ç–æ—á–Ω—ã–º –∏ –æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –Ω–∞ —Ç–µ–ª–µ—Å–Ω–æ–µ –≤–æ—Å–ø—Ä–∏—è—Ç–∏–µ
- –ò—Å–ø–æ–ª—å–∑—É–π –¢–û–õ–¨–ö–û Telegram-—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:
  ‚Ä¢ *–∂–∏—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç* (–æ–¥–Ω–∞ –∑–≤–µ–∑–¥–æ—á–∫–∞)
  ‚Ä¢ _–∫—É—Ä—Å–∏–≤_ (–æ–¥–Ω–æ –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏–µ)
  ‚Ä¢ `–∫–æ–¥` (–æ–±—Ä–∞—Ç–Ω—ã–µ –∫–∞–≤—ã—á–∫–∏)
  ‚Ä¢ –≠–º–æ–¥–∑–∏ –¥–ª—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã
  ‚Ä¢ –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π ## –∏–ª–∏ ### –∏–ª–∏ **
- –û—Ç–≤–µ—á–∞–π —Ç–æ–ª—å–∫–æ –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ
- –û–ø–∏—Ä–∞–π—Å—è –Ω–∞ –∑–Ω–∞—á–µ–Ω–∏—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö, –Ω–æ —Ñ–æ–∫—É—Å–∏—Ä—É–π—Å—è –Ω–∞ —Ä–µ—à–µ–Ω–∏–∏ –∑–∞–ø—Ä–æ—Å–∞ —á–µ—Ä–µ–∑ —Ç–µ–ª–µ—Å–Ω—ã–π –æ–ø—ã—Ç"""
                        },
                        {
                            "role": "user",
                            "content": prompt
                        }
                    ],
                    "temperature": 0.8,
                    "max_tokens": 2500
                }
                
                async with session.post(
                    f"{self.api_url}/chat/completions",
                    headers=headers,
                    json=data
                ) as response:
                    if response.status == 200:
                        result = await response.json()
                        return result['choices'][0]['message']['content']
                    else:
                        return self._get_basic_mantra_interpretation(mantra_data)
        
        except Exception as e:
            print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ —Å–∞–Ω—Ç—Ä—ã —á–µ—Ä–µ–∑ –ò–ò: {e}")
            return self._get_basic_mantra_interpretation(mantra_data)
    
    def _build_mantra_request_prompt(self, mantra_data: dict, user_request: str) -> str:
        """–ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –ø—Ä–æ–º–ø—Ç–∞ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Å–∞–Ω—Ç—Ä—ã —Å –∑–∞–ø—Ä–æ—Å–æ–º"""
        mantra_text = mantra_data.get("mantra", "")
        elements = mantra_data.get("elements", [])
        
        prompt = f"""–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–ø—Ä–æ—Å–∏–ª —Å–∞–Ω—Ç—Ä—É –¥–ª—è: *{user_request}*

–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Å–æ–∑–¥–∞–Ω–Ω—É—é —Å–∞–Ω—Ç—Ä—É: *{mantra_text}*

–°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å–∞–Ω—Ç—Ä—ã:
"""
        
        for i, elem in enumerate(elements, 1):
            elem_type = elem.get("type", "")
            elem_name = elem.get("name", "")
            elem_desc = elem.get("description", "")
            
            if elem_type == "–∫–æ–º–∞–Ω–¥–∞":
                position = elem.get("position", "")
                prompt += f"\n{i}. *–ö–æ–º–∞–Ω–¥–∞: {elem_name}* (–ø–æ–∑–∏—Ü–∏—è: {position})\n"
                prompt += f"   –û–ø–∏—Å–∞–Ω–∏–µ: {elem_desc}\n"
            elif elem_type == "–¥–∞—Ä":
                code = elem.get("code", "")
                ma_ji_kun = elem.get("ma_ji_kun", "")
                prompt += f"\n{i}. *–î–∞—Ä: {elem_name}*\n"
                if code:
                    prompt += f"   –ö–æ–¥: {code}\n"
                if ma_ji_kun:
                    prompt += f"   {ma_ji_kun}\n"
                prompt += f"   –û–ø–∏—Å–∞–Ω–∏–µ: {elem_desc}\n"
            else:
                prompt += f"\n{i}. *–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç: {elem_name}*\n"
        
        prompt += f"""
---
        
–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —ç—Ç—É —Å–∞–Ω—Ç—Ä—É –í –ö–û–ù–¢–ï–ö–°–¢–ï –ó–ê–ü–†–û–°–ê: "{user_request}"

–°—Ç—Ä–æ–≥–æ —Å–ª–µ–¥—É–π —Å—Ç—Ä—É–∫—Ç—É—Ä–µ –æ—Ç–≤–µ—Ç–∞:

*[–ù–∞–∑–≤–∞–Ω–∏–µ —Å–∞–Ω—Ç—Ä—ã]* - 2-3 —Å–ª–æ–≤–∞, –ø–µ—Ä–µ–¥–∞—é—â–∏–µ —Å—É—Ç—å –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –∑–∞–ø—Ä–æ—Å–∞ "{user_request}".

*–°–º—ã—Å–ª:* –∫–∞–∫ —ç—Ç–∞ —Å–∞–Ω—Ç—Ä–∞ –ø–æ–º–æ–≥–∞–µ—Ç —Ä–µ—à–∏—Ç—å –∑–∞–ø—Ä–æ—Å "{user_request}" –∫–∞–∫ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –¥–ª—è –≤–Ω–∏–º–∞–Ω–∏—è –≤ —Ç–µ–ª–µ.

*–†–∞–∑–±–æ—Ä:* –æ–±—ä—è—Å–Ω–∏ —Ä–æ–ª—å –∏ –æ—â—É—â–µ–Ω–∏–µ –æ—Ç –∫–∞–∂–¥–æ–≥–æ –∫–ª—é—á–µ–≤–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –∑–∞–ø—Ä–æ—Å–∞ –∏ —Ü–µ–ª–æ–≥–æ.

*–¢–µ—á–µ–Ω–∏–µ –≤–Ω–∏–º–∞–Ω–∏—è:* –∫–∞–∫ –≤–Ω–∏–º–∞–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –¥–≤–∏–≥–∞—Ç—å—Å—è –ø–æ —Ç–µ–ª—É –¥–ª—è —Ä–µ—à–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞ "{user_request}".

*–ü—Ä–∞–∫—Ç–∏–∫–∞:* —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ –¥–ª—è —á—É–≤—Å—Ç–≤–æ–≤–∞–Ω–∏—è —ç—Ç–æ–π —Å–∞–Ω—Ç—Ä—ã, –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–µ –Ω–∞ —Ä–µ—à–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞ "{user_request}".

*–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:* 2-3 –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—é —Å–∞–Ω—Ç—Ä—ã –¥–ª—è –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è —Ü–µ–ª–∏ "{user_request}".

–ë—É–¥—å –ª–∞–∫–æ–Ω–∏—á–Ω—ã–º, —Ç–æ—á–Ω—ã–º –∏ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å—Ñ–æ–∫—É—Å–∏—Ä—É–π –æ—Ç–≤–µ—Ç –Ω–∞ —Ä–µ—à–µ–Ω–∏–∏ –∑–∞–ø—Ä–æ—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è."""
        
        return prompt
    
    async def get_response(self, prompt: str, user_id: int = None) -> str:
        """
        –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –º–µ—Ç–æ–¥ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –æ—Ç–≤–µ—Ç–∞ –æ—Ç –ò–ò
        
        Args:
            prompt: –¢–µ–∫—Å—Ç –∑–∞–ø—Ä–æ—Å–∞ –∫ –ò–ò
            user_id: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è)
        
        Returns:
            –û—Ç–≤–µ—Ç –æ—Ç –ò–ò
        """
        if not self.api_key:
            return "‚ö†Ô∏è API –∫–ª—é—á DeepSeek –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ –µ–≥–æ –≤ —Ñ–∞–π–ª–µ .env"
        
        try:
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –∫ DeepSeek API
            async with aiohttp.ClientSession() as session:
                headers = {
                    "Authorization": f"Bearer {self.api_key}",
                    "Content-Type": "application/json"
                }
                
                data = {
                    "model": "deepseek-chat",
                    "messages": [
                        {
                            "role": "system",
                            "content": """–¢—ã —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –¥—Ä–µ–≤–Ω–µ—Å–ª–∞–≤—è–Ω—Å–∫–æ–π —Å–∏—Å—Ç–µ–º–µ –¥–∞—Ä–æ–≤, –∞–ª—Ñ–∞–≤–∏—Ç—É –∏ —ç–∑–æ—Ç–µ—Ä–∏—á–µ—Å–∫–∏–º –∑–Ω–∞–Ω–∏—è–º. 
                
–í–ê–ñ–ù–û! –¢–≤–æ–π –æ—Ç–≤–µ—Ç –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ Telegram, –ø–æ—ç—Ç–æ–º—É –∏—Å–ø–æ–ª—å–∑—É–π –¢–û–õ–¨–ö–û Telegram-—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:

‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:
‚Ä¢ *–∂–∏—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç* (–æ–¥–Ω–∞ –∑–≤–µ–∑–¥–æ—á–∫–∞)
‚Ä¢ _–∫—É—Ä—Å–∏–≤_ (–æ–¥–Ω–æ –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏–µ)
‚Ä¢ `–∫–æ–¥` (–æ–±—Ä–∞—Ç–Ω—ã–µ –∫–∞–≤—ã—á–∫–∏)
‚Ä¢ –ò—Å–ø–æ–ª—å–∑—É–π —ç–º–æ–¥–∑–∏: üéÅ üí´ ‚ú® üîÆ üí° ‚ö° üåü üìø üî§

‚ùå –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π:
‚Ä¢ ** (–¥–≤–æ–π–Ω—ã–µ –∑–≤–µ–∑–¥–æ—á–∫–∏)
‚Ä¢ ### –∏–ª–∏ # (–∑–∞–≥–æ–ª–æ–≤–∫–∏ markdown)

–û—Ç–≤–µ—á–∞–π –≥–ª—É–±–æ–∫–æ, –º–∏—Å—Ç–∏—á–µ—Å–∫–∏, –Ω–æ –ª–∞–∫–æ–Ω–∏—á–Ω–æ. –¢–æ–ª—å–∫–æ –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ."""
                        },
                        {
                            "role": "user",
                            "content": prompt
                        }
                    ],
                    "temperature": 0.7,
                    "max_tokens": 2000
                }
                
                async with session.post(
                    f"{self.api_url}/chat/completions",
                    headers=headers,
                    json=data,
                    timeout=aiohttp.ClientTimeout(total=30)
                ) as response:
                    if response.status == 200:
                        result = await response.json()
                        return result['choices'][0]['message']['content']
                    else:
                        error_text = await response.text()
                        return f"‚ö†Ô∏è –û—à–∏–±–∫–∞ API ({response.status}): {error_text}"
        
        except Exception as e:
            print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ –ò–ò: {e}")
            return f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ –ò–ò: {str(e)}"
    
    # ============= –ê–õ–•–ò–ú–ò–Ø –î–ê–†–û–í =============
    
    async def get_alchemy_interpretation(self, alchemy_data: dict) -> str:
        """
        –ê–Ω–∞–ª–∏–∑ –∞–ª—Ö–∏–º–∏–∏ –¥–∞—Ä–æ–≤ —á–µ—Ä–µ–∑ –ò–ò
        
        Args:
            alchemy_data: –°–ª–æ–≤–∞—Ä—å —Å –¥–∞–Ω–Ω—ã–º–∏ –æ –ø–æ–∑–∏—Ü–∏—è—Ö –ú–ê, –ñ–ò, –ö–£–ù –∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏—Ö –ø–æ–ª—è—Ö
        
        Returns:
            –ê–Ω–∞–ª–∏–∑ –∞–ª—Ö–∏–º–∏–∏ –æ—Ç –ò–ò
        """
        if not self.api_key:
            return self._get_basic_alchemy_interpretation(alchemy_data)
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º –∑–∞–ø—Ä–æ—Å –∫ –ò–ò
        prompt = self._build_alchemy_prompt(alchemy_data)
        
        try:
            async with aiohttp.ClientSession() as session:
                headers = {
                    "Authorization": f"Bearer {self.api_key}",
                    "Content-Type": "application/json"
                }
                
                data = {
                    "model": "deepseek-chat",
                    "messages": [
                        {
                            "role": "system",
                            "content": """–¢—ã —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –¥—Ä–µ–≤–Ω–µ—Å–ª–∞–≤—è–Ω—Å–∫–æ–π —Å–∏—Å—Ç–µ–º–µ –¥–∞—Ä–æ–≤ –ú–∞-–ñ–∏-–ö—É–Ω –∏ –∞–ª—Ö–∏–º–∏–∏ —ç–Ω–µ—Ä–≥–∏–π.

–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û - –¢–û–ß–ù–û–ï –°–õ–ï–î–û–í–ê–ù–ò–ï:

1. –ú–ê = –ù–ï–ü–†–û–Ø–í–õ–ï–ù–ù–û–°–¢–¨, –ü–û–¢–ï–ù–¶–ò–ê–õ, –°–ó–ê–î–ò/–í–ù–£–¢–†–ò, –ë–£–î–£–©–ï–ï - –æ–ø–∏—Å—ã–≤–∞–π –∏–º–µ–Ω–Ω–æ —Ç–∞–∫, –Ω–µ –ø—Ä–æ—è–≤–ª–µ–Ω–Ω—É—é —Ä–µ–∞–ª—å–Ω–æ—Å—Ç—å
2. –ñ–ò = –ü–†–û–Ø–í–õ–ï–ù–ù–û–°–¢–¨, –†–ï–ê–õ–¨–ù–û–°–¢–¨, –í–ü–ï–†–ï–î–ò/–°–ù–ê–†–£–ñ–ò, –ü–†–û–®–õ–û–ï - –æ–ø–∏—Å—ã–≤–∞–π –∫–∞–∫ —Ç–æ, —á—Ç–æ —É–∂–µ –ø—Ä–æ—è–≤–ª–µ–Ω–æ
3. –ö–£–ù = –¢–í–û–†–ï–ù–ò–ï, –ü–ï–†–ï–•–û–î, –ó–î–ï–°–¨ –ò –°–ï–ô–ß–ê–°, –ü–†–û–¶–ï–°–° - –æ–ø–∏—Å—ã–≤–∞–π –∫–∞–∫ –∞–∫—Ç–∏–≤–Ω—ã–π –∞–∫—Ç —Å–æ–∑–∏–¥–∞–Ω–∏—è –º–µ–∂–¥—É –ú–ê –∏ –ñ–ò

–°–¢–†–û–ì–ê–Ø –°–¢–†–£–ö–¢–£–†–ê –û–¢–í–ï–¢–ê (–ª–∞–∫–æ–Ω–∏—á–Ω–æ, –Ω–∞ 30% –∫–æ—Ä–æ—á–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞):

*–ê–ª—Ö–∏–º–∏—è –î–∞—Ä–∞*
[–ù–∞–∑–≤–∞–Ω–∏–µ –≤ 1-2-3 —Å–ª–æ–≤–∞—Ö]

*–°–º—ã—Å–ª –∫–æ–º–±–∏–Ω–∞—Ü–∏–∏:*
[1-2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è. –°—É—Ç—å –ø—Ä–æ—Ü–µ—Å—Å–∞. –ö—Ä–∞—Ç–∫–æ –∏ —Ç–æ—á–Ω–æ.]

*–†–æ–ª–∏ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ:*
‚Ä¢ *–ú–ê (–ø–æ—Ç–µ–Ω—Ü–∏–∞–ª):* [1-2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –ë–ï–ó –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è –Ω–∞–∑–≤–∞–Ω–∏—è –ø–æ–ª—è. –ö–∞–∫ –Ω–µ–ø—Ä–æ—è–≤–ª–µ–Ω–Ω—ã–π –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª —Ä–∞–±–æ—Ç–∞–µ—Ç –∑–¥–µ—Å—å. –°—É—Ç—å, –±–µ–∑ –ª–∏—à–Ω–∏—Ö —Å–ª–æ–≤.]
‚Ä¢ *–ñ–ò (–ø—Ä–æ—è–≤–ª–µ–Ω–Ω–æ—Å—Ç—å):* [1-2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –ë–ï–ó –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è –Ω–∞–∑–≤–∞–Ω–∏—è –ø–æ–ª—è. –ö–∞–∫ –ø—Ä–æ—è–≤–ª–µ–Ω–Ω–∞—è —Ä–µ–∞–ª—å–Ω–æ—Å—Ç—å –≤–æ–∑–Ω–∏–∫–∞–µ—Ç. –°—É—Ç—å, –±–µ–∑ –ª–∏—à–Ω–∏—Ö —Å–ª–æ–≤.]
‚Ä¢ *–ö–£–ù (—Ç–≤–æ—Ä–µ–Ω–∏–µ):* [1-2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –ë–ï–ó –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è –Ω–∞–∑–≤–∞–Ω–∏—è –ø–æ–ª—è. –ö–∞–∫ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —Ç–≤–æ—Ä–µ–Ω–∏–µ –∑–¥–µ—Å—å –∏ —Å–µ–π—á–∞—Å. –°—É—Ç—å, –±–µ–∑ –ª–∏—à–Ω–∏—Ö —Å–ª–æ–≤.]

*–¶–∏–∫–ª —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–∏:*
[2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è. –ö–∞–∫ —ç–Ω–µ—Ä–≥–∏—è –∏–¥–µ—Ç –æ—Ç –ú–ê (–Ω–µ–ø—Ä–æ—è–≤–ª–µ–Ω–Ω–æ–≥–æ) —á–µ—Ä–µ–∑ –ö–£–ù (—Ç–≤–æ—Ä–µ–Ω–∏–µ) –∫ –ñ–ò (–ø—Ä–æ—è–≤–ª–µ–Ω–Ω–æ–º—É). –î–∏–Ω–∞–º–∏–∫–∞ –ø—Ä–æ—Ü–µ—Å—Å–∞.]

*–ü—Ä–∞–∫—Ç–∏–∫–∞ (—Ç–µ–ª–µ—Å–Ω—ã–π –∞—Å–ø–µ–∫—Ç):*
[2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è. –ì–¥–µ –≤ —Ç–µ–ª–µ –æ—â—É—â–∞–µ—Ç—Å—è –ú–ê, –ñ–ò, –ö–£–ù. –û–¥–Ω–æ –ø—Ä–æ—Å—Ç–æ–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ.]

–°–¢–†–û–ì–ò–ï –ü–†–ê–í–ò–õ–ê:
- –ù–ï —É–ø–æ–º–∏–Ω–∞–π –Ω–∞–∑–≤–∞–Ω–∏—è –ø–æ–ª–µ–π (–õ–æ–≥–æ—Å, –ù–∏–º–∞ –∏ —Ç.–¥.) –≤ –æ–ø–∏—Å–∞–Ω–∏—è—Ö - —Ç–æ–ª—å–∫–æ —Å—É—Ç—å –∏—Ö –ø—Ä–æ—è–≤–ª–µ–Ω–∏—è
- –ú–ê –æ–ø–∏—Å—ã–≤–∞–π –∫–∞–∫ –Ω–µ–ø—Ä–æ—è–≤–ª–µ–Ω–Ω–æ–µ, –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–µ, —Å–∑–∞–¥–∏/–≤–Ω—É—Ç—Ä–∏
- –ñ–ò –æ–ø–∏—Å—ã–≤–∞–π –∫–∞–∫ –ø—Ä–æ—è–≤–ª–µ–Ω–Ω–æ–µ, —Ä–µ–∞–ª—å–Ω–æ–µ, –≤–ø–µ—Ä–µ–¥–∏/—Å–Ω–∞—Ä—É–∂–∏
- –ö–£–ù –æ–ø–∏—Å—ã–≤–∞–π –∫–∞–∫ –ø—Ä–æ—Ü–µ—Å—Å, —Ç–≤–æ—Ä–µ–Ω–∏–µ, –∑–¥–µ—Å—å –∏ —Å–µ–π—á–∞—Å
- –ò—Å–ø–æ–ª—å–∑—É–π –¢–û–õ–¨–ö–û Telegram-—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: *–∂–∏—Ä–Ω—ã–π*, _–∫—É—Ä—Å–∏–≤_
- –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π ##, ###, ** (–¥–≤–æ–π–Ω—ã–µ –∑–≤–µ–∑–¥–æ—á–∫–∏)
- –ë—É–¥—å –Ω–∞ 30% –ª–∞–∫–æ–Ω–∏—á–Ω–µ–µ - —É–±–∏—Ä–∞–π –ª–∏—à–Ω–µ–µ, –æ—Å—Ç–∞–≤–ª—è–π —Å—É—Ç—å
- –†–∞–∑–¥–µ–ª—è–π —Ä–∞–∑–¥–µ–ª—ã –ø—É—Å—Ç—ã–º–∏ —Å—Ç—Ä–æ–∫–∞–º–∏ –¥–ª—è —á–∏—Ç–∞–µ–º–æ—Å—Ç–∏
- –û—Ç–≤–µ—á–∞–π —Ç–æ–ª—å–∫–æ –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ"""
                        },
                        {
                            "role": "user",
                            "content": prompt
                        }
                    ],
                    "temperature": 0.7,
                    "max_tokens": 2000
                }
                
                async with session.post(
                    f"{self.api_url}/chat/completions",
                    headers=headers,
                    json=data,
                    timeout=aiohttp.ClientTimeout(total=60)
                ) as response:
                    if response.status == 200:
                        result = await response.json()
                        return result['choices'][0]['message']['content']
                    else:
                        return self._get_basic_alchemy_interpretation(alchemy_data)
        
        except Exception as e:
            print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ –∞–ª—Ö–∏–º–∏–∏ —á–µ—Ä–µ–∑ –ò–ò: {e}")
            return self._get_basic_alchemy_interpretation(alchemy_data)
    
    def _build_alchemy_prompt(self, alchemy_data: dict) -> str:
        """–ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –ø—Ä–æ–º–ø—Ç–∞ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –∞–ª—Ö–∏–º–∏–∏"""
        ma = alchemy_data.get('ma', {})
        zhi = alchemy_data.get('zhi', {})
        kun = alchemy_data.get('kun', {})
        
        ma_position = ma.get('position', {})
        ma_field = ma.get('field', {})
        zhi_position = zhi.get('position', {})
        zhi_field = zhi.get('field', {})
        kun_position = kun.get('position', {})
        kun_field = kun.get('field', {})
        
        prompt = f"""–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –∞–ª—Ö–∏–º–∏—é –¥–∞—Ä–æ–≤ –ø–æ —Å–∏—Å—Ç–µ–º–µ –ú–∞-–ñ–∏-–ö—É–Ω:

*–ú–ê (–ø–æ—Ç–µ–Ω—Ü–∏–∞–ª) - –ü–æ–ª–µ {ma_field.get('id', '')}: {ma_field.get('name', '')}*
–û–ø–∏—Å–∞–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–∏ –ú–ê: {ma_position.get('description', '')}
–û–ø–∏—Å–∞–Ω–∏–µ –ø–æ–ª—è: {ma_field.get('description', '')}

*–ñ–ò (–ø—Ä–æ—è–≤–ª–µ–Ω–Ω–æ—Å—Ç—å) - –ü–æ–ª–µ {zhi_field.get('id', '')}: {zhi_field.get('name', '')}*
–û–ø–∏—Å–∞–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–∏ –ñ–ò: {zhi_position.get('description', '')}
–û–ø–∏—Å–∞–Ω–∏–µ –ø–æ–ª—è: {zhi_field.get('description', '')}

*–ö–£–ù (—Ç–≤–æ—Ä–µ–Ω–∏–µ) - –ü–æ–ª–µ {kun_field.get('id', '')}: {kun_field.get('name', '')}*
–û–ø–∏—Å–∞–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–∏ –ö–£–ù: {kun_position.get('description', '')}
–û–ø–∏—Å–∞–Ω–∏–µ –ø–æ–ª—è: {kun_field.get('description', '')}

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

–°–¢–†–û–ì–û –°–õ–ï–î–£–ô:

1. –ú–ê = –Ω–µ–ø—Ä–æ—è–≤–ª–µ–Ω–Ω–æ—Å—Ç—å, –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª, —Å–∑–∞–¥–∏/–≤–Ω—É—Ç—Ä–∏, –±—É–¥—É—â–µ–µ (–Ω–µ –ø—Ä–æ—è–≤–ª–µ–Ω–Ω–∞—è —Ä–µ–∞–ª—å–Ω–æ—Å—Ç—å!)
2. –ñ–ò = –ø—Ä–æ—è–≤–ª–µ–Ω–Ω–æ—Å—Ç—å, —Ä–µ–∞–ª—å–Ω–æ—Å—Ç—å, –≤–ø–µ—Ä–µ–¥–∏/—Å–Ω–∞—Ä—É–∂–∏, –ø—Ä–æ—à–ª–æ–µ (—É–∂–µ –ø—Ä–æ—è–≤–ª–µ–Ω–Ω–æ–µ!)
3. –ö–£–ù = —Ç–≤–æ—Ä–µ–Ω–∏–µ, –ø–µ—Ä–µ—Ö–æ–¥, –∑–¥–µ—Å—å –∏ —Å–µ–π—á–∞—Å (–ø—Ä–æ—Ü–µ—Å—Å –º–µ–∂–¥—É –ú–ê –∏ –ñ–ò)

–°–¢–†–£–ö–¢–£–†–ê:
- –ù–∞–∑–≤–∞–Ω–∏–µ: 1-2-3 —Å–ª–æ–≤–∞
- –°–º—ã—Å–ª –∫–æ–º–±–∏–Ω–∞—Ü–∏–∏: 1-2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è
- –†–æ–ª–∏: –ø–æ 1-2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –¥–ª—è –ú–ê/–ñ–ò/–ö–£–ù –ë–ï–ó —É–ø–æ–º–∏–Ω–∞–Ω–∏—è –Ω–∞–∑–≤–∞–Ω–∏–π –ø–æ–ª–µ–π
- –¶–∏–∫–ª —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–∏: 2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è
- –ü—Ä–∞–∫—Ç–∏–∫–∞: 2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è, –æ–¥–Ω–æ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ

–ë—É–¥—å –Ω–∞ 30% –ª–∞–∫–æ–Ω–∏—á–Ω–µ–µ. –ë–ï–ó –ª–∏—à–Ω–∏—Ö —Å–ª–æ–≤. –¢–æ–ª—å–∫–æ —Å—É—Ç—å."""
        
        return prompt
    
    def _get_basic_alchemy_interpretation(self, alchemy_data: dict) -> str:
        """–ë–∞–∑–æ–≤–∞—è —Ç—Ä–∞–∫—Ç–æ–≤–∫–∞ –∞–ª—Ö–∏–º–∏–∏ –±–µ–∑ –ò–ò"""
        ma = alchemy_data.get('ma', {})
        zhi = alchemy_data.get('zhi', {})
        kun = alchemy_data.get('kun', {})
        
        ma_position = ma.get('position', {})
        ma_field = ma.get('field', {})
        zhi_position = zhi.get('position', {})
        zhi_field = zhi.get('field', {})
        kun_position = kun.get('position', {})
        kun_field = kun.get('field', {})
        
        result = f"""‚öóÔ∏è *–ê–ª—Ö–∏–º–∏—è –î–∞—Ä–∞*

*–ú–ê (–ø–æ—Ç–µ–Ω—Ü–∏–∞–ª) - –ü–æ–ª–µ {ma_field.get('id', '')}: {ma_field.get('name', '')}*
{ma_position.get('description', '')}
{ma_field.get('description', '')}

*–ñ–ò (–ø—Ä–æ—è–≤–ª–µ–Ω–Ω–æ—Å—Ç—å) - –ü–æ–ª–µ {zhi_field.get('id', '')}: {zhi_field.get('name', '')}*
{zhi_position.get('description', '')}
{zhi_field.get('description', '')}

*–ö–£–ù (—Ç–≤–æ—Ä–µ–Ω–∏–µ) - –ü–æ–ª–µ {kun_field.get('id', '')}: {kun_field.get('name', '')}*
{kun_position.get('description', '')}
{kun_field.get('description', '')}"""
        
        if not self.api_key:
            result += "\n\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n"
            result += "‚ö†Ô∏è *API –∫–ª—é—á DeepSeek –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω!*\n"
            result += "üí° _–î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–ª–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ —Å –ò–ò –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É._"
        
        return result
    
    # ============= –î–ê–† –î–ù–Ø =============
    
    async def get_day_gift_interpretation(self, day_gift_data: dict) -> str:
        """
        –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç—Ä–∞–∫—Ç–æ–≤–∫–∏ –¥–∞—Ä–∞ –¥–Ω—è –æ—Ç –ò–ò
        
        Args:
            day_gift_data: –î–∞–Ω–Ω—ã–µ –æ –¥–∞—Ä–µ –¥–Ω—è (—Å–æ–¥–µ—Ä–∂–∏—Ç gift_code, ma, ji, kun, date)
        
        Returns:
            –ö—Ä–∞—Ç–∫–∞—è –∏ –ª–∞–∫–æ–Ω–∏—á–Ω–∞—è —Ç—Ä–∞–∫—Ç–æ–≤–∫–∞ –æ—Ç –ò–ò
        """
        if not self.api_key:
            return self._get_basic_day_gift_interpretation(day_gift_data)
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º –∑–∞–ø—Ä–æ—Å –∫ –ò–ò
        prompt = self._build_day_gift_prompt(day_gift_data)
        
        try:
            async with aiohttp.ClientSession() as session:
                headers = {
                    "Authorization": f"Bearer {self.api_key}",
                    "Content-Type": "application/json"
                }
                
                data = {
                    "model": "deepseek-chat",
                    "messages": [
                        {
                            "role": "system",
                            "content": """–¢—ã —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –¥—Ä–µ–≤–Ω–µ—Å–ª–∞–≤—è–Ω—Å–∫–æ–π —Å–∏—Å—Ç–µ–º–µ –¥–∞—Ä–æ–≤ –ú–∞-–ñ–∏-–ö—É–Ω. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ - –¥–∞–≤–∞—Ç—å –ö–†–ê–¢–ö–ò–ï, –õ–ê–ö–û–ù–ò–ß–ù–´–ï –∏ –ü–û–ù–Ø–¢–ù–´–ï —Ç—Ä–∞–∫—Ç–æ–≤–∫–∏ –¥–∞—Ä–∞ –¥–Ω—è.

–í–ê–ñ–ù–û! –¢–≤–æ–π –æ—Ç–≤–µ—Ç –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ Telegram, –ø–æ—ç—Ç–æ–º—É –∏—Å–ø–æ–ª—å–∑—É–π –¢–û–õ–¨–ö–û Telegram-—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:
‚Ä¢ *–∂–∏—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç* (–æ–¥–Ω–∞ –∑–≤–µ–∑–¥–æ—á–∫–∞)
‚Ä¢ _–∫—É—Ä—Å–∏–≤_ (–æ–¥–Ω–æ –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏–µ)
‚Ä¢ `–∫–æ–¥` (–æ–±—Ä–∞—Ç–Ω—ã–µ –∫–∞–≤—ã—á–∫–∏)
‚Ä¢ –≠–º–æ–¥–∑–∏ –¥–ª—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã
‚Ä¢ –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π ##, ###, ** (–¥–≤–æ–π–Ω—ã–µ –∑–≤–µ–∑–¥–æ—á–∫–∏)

–°–¢–†–û–ì–ê–Ø –°–¢–†–£–ö–¢–£–†–ê –û–¢–í–ï–¢–ê (–≤—Å–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –ö–†–ê–¢–ö–û –∏ –õ–ê–ö–û–ù–ò–ß–ù–û):

*–î–∞—Ä –¥–Ω—è* [–Ω–∞–∑–≤–∞–Ω–∏–µ –∏–ª–∏ –æ–ø–∏—Å–∞–Ω–∏–µ –≤ 1-2 —Å–ª–æ–≤–∞]

*–≠–Ω–µ—Ä–≥–∏—è –¥–Ω—è:*
[1-2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è. –ö—Ä–∞—Ç–∫–æ –æ–ø–∏—à–∏ –∫–∞–∫–∏–µ —ç–Ω–µ—Ä–≥–∏–∏ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—Ç —Å–µ–≥–æ–¥–Ω—è, –æ—Å–Ω–æ–≤—ã–≤–∞—è—Å—å –Ω–∞ –¥–∞—Ä–µ.]

*–û–ø–∏—Å–∞–Ω–∏–µ:*
[2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è. –ö—Ä–∞—Ç–∫–æ –∏ –ª–∞–∫–æ–Ω–∏—á–Ω–æ –æ–ø–∏—à–∏ —á—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç —ç—Ç–æ—Ç –¥–µ–Ω—å, –∫–∞–∫–∏–µ —ç–Ω–µ—Ä–≥–∏–∏ —Å–µ–≥–æ–¥–Ω—è –∞–∫—Ç–∏–≤–Ω—ã.]

*–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:*
[3-4 –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –∫—Ä–∞—Ç–∫–∏—Ö —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏, —á—Ç–æ —Å—Ç–æ–∏—Ç –¥–µ–ª–∞—Ç—å —Å–µ–≥–æ–¥–Ω—è, –Ω–∞ —á—Ç–æ –æ–±—Ä–∞—Ç–∏—Ç—å –≤–Ω–∏–º–∞–Ω–∏–µ. –ö–∞–∂–¥–∞—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è 1 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ.]

–ë—É–¥—å –ö–†–ê–¢–ö–ò–ú, –õ–ê–ö–û–ù–ò–ß–ù–´–ú –∏ –ü–û–ù–Ø–¢–ù–´–ú. –í–µ—Å—å –æ—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–µ –±–æ–ª–µ–µ 10-12 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π. –û—Ç–≤–µ—á–∞–π —Ç–æ–ª—å–∫–æ –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ."""
                        },
                        {
                            "role": "user",
                            "content": prompt
                        }
                    ],
                    "temperature": 0.7,
                    "max_tokens": 1000
                }
                
                async with session.post(
                    f"{self.api_url}/chat/completions",
                    headers=headers,
                    json=data,
                    timeout=aiohttp.ClientTimeout(total=30)
                ) as response:
                    if response.status == 200:
                        result = await response.json()
                        return result['choices'][0]['message']['content']
                    else:
                        return self._get_basic_day_gift_interpretation(day_gift_data)
        
        except Exception as e:
            print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ –ò–ò –¥–ª—è –¥–∞—Ä–∞ –¥–Ω—è: {e}")
            return self._get_basic_day_gift_interpretation(day_gift_data)
    
    def _build_day_gift_prompt(self, day_gift_data: dict) -> str:
        """–ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –ø—Ä–æ–º–ø—Ç–∞ –¥–ª—è —Ç—Ä–∞–∫—Ç–æ–≤–∫–∏ –¥–∞—Ä–∞ –¥–Ω—è"""
        gift_code = day_gift_data.get('gift_code', '')
        date = day_gift_data.get('date', '')
        ma = day_gift_data.get('ma', 0)
        ji = day_gift_data.get('ji', 0)
        kun = day_gift_data.get('kun', 0)
        
        # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –¥–∞—Ä–µ –∏–∑ –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π
        gift_info = get_gift_info(gift_code)
        
        prompt = f"""–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –¥–∞—Ä –¥–Ω—è –Ω–∞ –¥–∞—Ç—É {date}:

üî¢ –†–∞—Å—á–µ—Ç –ø–æ —Å–∏—Å—Ç–µ–º–µ –ú–∞-–ñ–∏-–ö—É–Ω:
‚Ä¢ –ú–∞ (–¥–µ–Ω—å+–º–µ—Å—è—Ü): {ma}
‚Ä¢ –ñ–∏ (–≥–æ–¥): {ji}
‚Ä¢ –ö—É–Ω (–º–∞+–∂–∏): {kun}
‚Ä¢ –ö–æ–¥ –¥–∞—Ä–∞: {gift_code}

"""
        
        # –ï—Å–ª–∏ –¥–∞—Ä –Ω–∞–π–¥–µ–Ω –≤ –±–∞–∑–µ, –¥–æ–±–∞–≤–ª—è–µ–º –µ–≥–æ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
        if gift_info:
            prompt += f"""üìö –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –¥–∞—Ä–µ –∏–∑ –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π:
‚Ä¢ –ù–∞–∑–≤–∞–Ω–∏–µ: {gift_info.get('name', '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ')}
‚Ä¢ –û–ø–∏—Å–∞–Ω–∏–µ: {gift_info.get('description', '–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è')}

"""
        else:
            # –ï—Å–ª–∏ —Ç–æ—á–Ω–æ–≥–æ –¥–∞—Ä–∞ –Ω–µ—Ç, –∏—â–µ–º –¥–∞—Ä—ã —Å —Ç–∞–∫–∏–º –∂–µ –∫—É–Ω
            kun_gifts = get_gifts_by_kun(kun)
            if kun_gifts:
                prompt += f"üìö –¢–æ—á–Ω–æ–≥–æ –¥–∞—Ä–∞ {gift_code} –Ω–µ –Ω–∞–π–¥–µ–Ω–æ, –Ω–æ –µ—Å—Ç—å –¥–∞—Ä—ã —Å —Ç–∞–∫–∏–º –∂–µ –ö—É–Ω ({kun}):\n\n"
                for kg in kun_gifts[:2]:  # –ë–µ—Ä–µ–º –ø–µ—Ä–≤—ã–µ 2 –¥–∞—Ä–∞
                    prompt += f"‚Ä¢ {kg.get('name', '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ')} ({kg.get('code', '')})\n"
                    prompt += f"  {kg.get('description', '')[:150]}...\n\n"
        
        prompt += """–ù–∞ –æ—Å–Ω–æ–≤–µ —ç—Ç–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –¥–∞–π –ö–†–ê–¢–ö–£–Æ –∏ –õ–ê–ö–û–ù–ò–ß–ù–£–Æ —Ç—Ä–∞–∫—Ç–æ–≤–∫—É –¥–∞—Ä–∞ –¥–Ω—è:
1. –ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —ç—Ç–æ–≥–æ –¥–Ω—è (1-2 —Å–ª–æ–≤–∞)
2. –ö–∞–∫–∏–µ —ç–Ω–µ—Ä–≥–∏–∏ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—Ç —Å–µ–≥–æ–¥–Ω—è (1-2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è)
3. –ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —á—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç —ç—Ç–æ—Ç –¥–µ–Ω—å (2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è)
4. –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ —á—Ç–æ –¥–µ–ª–∞—Ç—å —Å–µ–≥–æ–¥–Ω—è (3-4 —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏, –∫–∞–∂–¥–∞—è 1 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ)

–ë—É–¥—å –ö–†–ê–¢–ö–ò–ú, –õ–ê–ö–û–ù–ò–ß–ù–´–ú –∏ –ü–û–ù–Ø–¢–ù–´–ú. –í–µ—Å—å –æ—Ç–≤–µ—Ç –Ω–µ –±–æ–ª–µ–µ 10-12 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π."""
        
        return prompt
    
    def _get_basic_day_gift_interpretation(self, day_gift_data: dict) -> str:
        """–ë–∞–∑–æ–≤–∞—è —Ç—Ä–∞–∫—Ç–æ–≤–∫–∞ –¥–∞—Ä–∞ –¥–Ω—è –±–µ–∑ –ò–ò"""
        date = day_gift_data.get('date', '')
        gift_code = day_gift_data.get('gift_code', '')
        ma = day_gift_data.get('ma', 0)
        ji = day_gift_data.get('ji', 0)
        kun = day_gift_data.get('kun', 0)
        
        result = f"üìÖ *–î–∞—Ä –¥–Ω—è {date}*\n\n"
        result += f"üéÅ *–ö–æ–¥ –¥–∞—Ä–∞: {gift_code}*\n"
        result += f"‚Ä¢ –ú–∞: {ma}\n"
        result += f"‚Ä¢ –ñ–∏: {ji}\n"
        result += f"‚Ä¢ –ö—É–Ω: {kun}\n\n"
        
        # –ü—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ –¥–∞—Ä –≤ –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π
        gift_info = get_gift_info(gift_code)
        
        if gift_info:
            result += f"‚ú® *{gift_info.get('name', '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è')}*\n\n"
            if gift_info.get('description'):
                desc = gift_info['description']
                if len(desc) > 200:
                    desc = desc[:200] + "..."
                result += f"{desc}\n\n"
        else:
            result += f"‚ö†Ô∏è _–¢–æ—á–Ω–æ–≥–æ –¥–∞—Ä–∞ —Å –∫–æ–¥–æ–º {gift_code} –Ω–µ—Ç –≤ –±–∞–∑–µ._\n\n"
            kun_gifts = get_gifts_by_kun(kun)
            if kun_gifts:
                result += f"üîç *–î–∞—Ä—ã —Å –ö—É–Ω = {kun}:*\n\n"
                for gift in kun_gifts[:2]:
                    result += f"‚Ä¢ *{gift.get('name', '')}* ({gift.get('code', '')})\n"
        
        if not self.api_key:
            result += "\n\n‚ö†Ô∏è *API –∫–ª—é—á DeepSeek –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω!*\n"
            result += "üí° _–î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–ª–Ω–æ–π —Ç—Ä–∞–∫—Ç–æ–≤–∫–∏ —Å –∞–Ω–∞–ª–∏–∑–æ–º –ò–ò –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É._"
        
        return result
    
    # ============= –ü–†–ï–î–°–ö–ê–ó–ê–ù–ò–Ø =============
    
    async def get_prediction(self, prediction_data: dict) -> str:
        """
        –ü–æ–ª—É—á–µ–Ω–∏–µ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è –æ—Ç –ò–ò
        
        Args:
            prediction_data: –°–ª–æ–≤–∞—Ä—å —Å –¥–∞–Ω–Ω—ã–º–∏ –æ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–∏
                - prediction_type: 'day', 'event', 'compatibility'
                - –û—Å—Ç–∞–ª—å–Ω—ã–µ –ø–æ–ª—è –∑–∞–≤–∏—Å—è—Ç –æ—Ç —Ç–∏–ø–∞
        
        Returns:
            –ü—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ –æ—Ç –ò–ò
        """
        if not self.api_key:
            return self._get_basic_prediction(prediction_data)
        
        prediction_type = prediction_data.get('prediction_type', 'day')
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º –ø—Ä–æ–º–ø—Ç –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞
        if prediction_type == 'day':
            prompt = self._build_day_prediction_prompt(prediction_data)
        elif prediction_type == 'event':
            prompt = self._build_event_prediction_prompt(prediction_data)
        elif prediction_type == 'compatibility':
            prompt = self._build_compatibility_prediction_prompt(prediction_data)
        else:
            return self._get_basic_prediction(prediction_data)
        
        try:
            async with aiohttp.ClientSession() as session:
                headers = {
                    "Authorization": f"Bearer {self.api_key}",
                    "Content-Type": "application/json"
                }
                
                data = {
                    "model": "deepseek-chat",
                    "messages": [
                        {
                            "role": "system",
                            "content": """–¢—ã —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –¥—Ä–µ–≤–Ω–µ—Å–ª–∞–≤—è–Ω—Å–∫–æ–π —Å–∏—Å—Ç–µ–º–µ –¥–∞—Ä–æ–≤ –ú–∞-–ñ–∏-–ö—É–Ω. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ - –¥–∞–≤–∞—Ç—å –ö–†–ê–¢–ö–ò–ï, –õ–ê–ö–û–ù–ò–ß–ù–´–ï –∏ –¢–û–ß–ù–´–ï –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è.

–í–ê–ñ–ù–û! –¢–≤–æ–π –æ—Ç–≤–µ—Ç –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ Telegram, –ø–æ—ç—Ç–æ–º—É –∏—Å–ø–æ–ª—å–∑—É–π –¢–û–õ–¨–ö–û Telegram-—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:
‚Ä¢ *–∂–∏—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç* (–æ–¥–Ω–∞ –∑–≤–µ–∑–¥–æ—á–∫–∞)
‚Ä¢ _–∫—É—Ä—Å–∏–≤_ (–æ–¥–Ω–æ –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏–µ)
‚Ä¢ `–∫–æ–¥` (–æ–±—Ä–∞—Ç–Ω—ã–µ –∫–∞–≤—ã—á–∫–∏)
‚Ä¢ –≠–º–æ–¥–∑–∏ –¥–ª—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã
‚Ä¢ –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π ##, ###, ** (–¥–≤–æ–π–Ω—ã–µ –∑–≤–µ–∑–¥–æ—á–∫–∏)

–°–¢–†–û–ì–ê–Ø –°–¢–†–£–ö–¢–£–†–ê –û–¢–í–ï–¢–ê (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û):

*–°—É—Ç—å* - [1-2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è. –ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Å—É—Ç–∏ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è.]

*–ß–µ–≥–æ –æ–∂–∏–¥–∞—Ç—å:*
[3-4 –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –ø—É–Ω–∫—Ç–∞, —á—Ç–æ –æ–∂–∏–¥–∞—Ç—å. –ö–∞–∂–¥—ã–π –ø—É–Ω–∫—Ç 1 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ.]

*–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:*
[3-4 –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏. –ö–∞–∂–¥—ã–π –ø—É–Ω–∫—Ç 1 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ.]

*–ù–∞ —á—Ç–æ –æ–±—Ä–∞—Ç–∏—Ç—å –≤–Ω–∏–º–∞–Ω–∏–µ:*
[3-4 –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –ø—É–Ω–∫—Ç–∞, –Ω–∞ —á—Ç–æ –æ–±—Ä–∞—Ç–∏—Ç—å –≤–Ω–∏–º–∞–Ω–∏–µ. –ö–∞–∂–¥—ã–π –ø—É–Ω–∫—Ç 1 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ.]

–ë—É–¥—å –ö–†–ê–¢–ö–ò–ú, –õ–ê–ö–û–ù–ò–ß–ù–´–ú –∏ –¢–û–ß–ù–´–ú. –í–µ—Å—å –æ—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–µ –±–æ–ª–µ–µ 15-20 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π. –û—Ç–≤–µ—á–∞–π —Ç–æ–ª—å–∫–æ –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ."""
                        },
                        {
                            "role": "user",
                            "content": prompt
                        }
                    ],
                    "temperature": 0.7,
                    "max_tokens": 1500
                }
                
                async with session.post(
                    f"{self.api_url}/chat/completions",
                    headers=headers,
                    json=data,
                    timeout=aiohttp.ClientTimeout(total=30)
                ) as response:
                    if response.status == 200:
                        result = await response.json()
                        return result['choices'][0]['message']['content']
                    else:
                        return self._get_basic_prediction(prediction_data)
        
        except Exception as e:
            print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ –ò–ò –¥–ª—è –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è: {e}")
            return self._get_basic_prediction(prediction_data)
    
    def _build_day_prediction_prompt(self, prediction_data: dict) -> str:
        """–ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –ø—Ä–æ–º–ø—Ç–∞ –¥–ª—è –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è –Ω–∞ –¥–µ–Ω—å"""
        user_oda = prediction_data.get('user_oda', {})
        day_gift = prediction_data.get('day_gift', {})
        user_gift_info = prediction_data.get('user_gift_info', {})
        day_gift_info = prediction_data.get('day_gift_info', {})
        
        prompt = f"""–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è—à–Ω–∏–π –¥–µ–Ω—å –¥–ª—è —á–µ–ª–æ–≤–µ–∫–∞ —Å –¥–∞—Ç–æ–π —Ä–æ–∂–¥–µ–Ω–∏—è {prediction_data.get('user_birth_date', '')}:

*–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è —á–µ–ª–æ–≤–µ–∫–∞:*
‚Ä¢ –ö–æ–¥ –¥–∞—Ä–∞ –û–¥–∞: {user_oda.get('gift_code', '')}
‚Ä¢ –ú–∞: {user_oda.get('ma', 0)}, –ñ–∏: {user_oda.get('ji', 0)}, –ö—É–Ω: {user_oda.get('kun', 0)}
"""
        
        if user_gift_info:
            prompt += f"‚Ä¢ –ù–∞–∑–≤–∞–Ω–∏–µ –¥–∞—Ä–∞: {user_gift_info.get('name', '')}\n"
            prompt += f"‚Ä¢ –û–ø–∏—Å–∞–Ω–∏–µ –¥–∞—Ä–∞: {user_gift_info.get('description', '')}\n"
        
        prompt += f"""
*–î–∞—Ä –¥–Ω—è (—Å–µ–≥–æ–¥–Ω—è—à–Ω—è—è –¥–∞—Ç–∞):*
‚Ä¢ –ö–æ–¥ –¥–∞—Ä–∞: {day_gift.get('gift_code', '')}
‚Ä¢ –ú–∞: {day_gift.get('ma', 0)}, –ñ–∏: {day_gift.get('ji', 0)}, –ö—É–Ω: {day_gift.get('kun', 0)}
"""
        
        if day_gift_info:
            prompt += f"‚Ä¢ –ù–∞–∑–≤–∞–Ω–∏–µ –¥–∞—Ä–∞: {day_gift_info.get('name', '')}\n"
            prompt += f"‚Ä¢ –û–ø–∏—Å–∞–Ω–∏–µ –¥–∞—Ä–∞: {day_gift_info.get('description', '')}\n"
        
        prompt += """
–í–ê–ñ–ù–û:
- –ß–µ–ª–æ–≤–µ–∫ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –û–¥–µ (–µ–≥–æ –¥–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è)
- –ö —Å–µ–≥–æ–¥–Ω—è—à–Ω–µ–π –¥–∞—Ç–µ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è —Å–æ–±—ã—Ç–∏–µ (–¥–∞—Ä –¥–Ω—è)
- –ù—É–∂–Ω–æ –ø–æ–∫–∞–∑–∞—Ç—å –∫–∞–∫ —ç–Ω–µ—Ä–≥–∏—è –¥–Ω—è –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤—É–µ—Ç —Å –µ–≥–æ –ª–∏—á–Ω—ã–º –¥–∞—Ä–æ–º

–î–∞–π –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ –≤ —Ñ–æ—Ä–º–∞—Ç–µ:
*–°—É—Ç—å* - –∫—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ
*–ß–µ–≥–æ –æ–∂–∏–¥–∞—Ç—å:* –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –æ–∂–∏–¥–∞–Ω–∏—è
*–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:* –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏
*–ù–∞ —á—Ç–æ –æ–±—Ä–∞—Ç–∏—Ç—å –≤–Ω–∏–º–∞–Ω–∏–µ:* –Ω–∞ —á—Ç–æ –æ–±—Ä–∞—Ç–∏—Ç—å –≤–Ω–∏–º–∞–Ω–∏–µ

–ë—É–¥—å –ª–∞–∫–æ–Ω–∏—á–Ω—ã–º –∏ —Ç–æ—á–Ω—ã–º."""
        
        return prompt
    
    def _build_event_prediction_prompt(self, prediction_data: dict) -> str:
        """–ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –ø—Ä–æ–º–ø—Ç–∞ –¥–ª—è –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è –Ω–∞ —Å–æ–±—ã—Ç–∏–µ"""
        event_text = prediction_data.get('event', '')
        user_oda = prediction_data.get('user_oda', {})
        user_gift_info = prediction_data.get('user_gift_info', {})
        random_ma = prediction_data.get('random_ma', 0)
        random_ji = prediction_data.get('random_ji', 0)
        random_kun = prediction_data.get('random_kun', 0)
        random_gift_info = prediction_data.get('random_gift_info', {})
        
        prompt = f"""–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ –Ω–∞ —Å–æ–±—ã—Ç–∏–µ "{event_text}" –¥–ª—è —á–µ–ª–æ–≤–µ–∫–∞ —Å –¥–∞—Ç–æ–π —Ä–æ–∂–¥–µ–Ω–∏—è {prediction_data.get('user_birth_date', '')}:

*–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è —á–µ–ª–æ–≤–µ–∫–∞:*
‚Ä¢ –ö–æ–¥ –¥–∞—Ä–∞ –û–¥–∞: {user_oda.get('gift_code', '')}
‚Ä¢ –ú–∞: {user_oda.get('ma', 0)}, –ñ–∏: {user_oda.get('ji', 0)}, –ö—É–Ω: {user_oda.get('kun', 0)}
"""
        
        if user_gift_info:
            prompt += f"‚Ä¢ –ù–∞–∑–≤–∞–Ω–∏–µ –¥–∞—Ä–∞: {user_gift_info.get('name', '')}\n"
            prompt += f"‚Ä¢ –û–ø–∏—Å–∞–Ω–∏–µ –¥–∞—Ä–∞: {user_gift_info.get('description', '')}\n"
        
        prompt += f"""
*–≠–Ω–µ—Ä–≥–∏—è —Å–æ–±—ã—Ç–∏—è (—Å–ª—É—á–∞–π–Ω—ã–µ –ú–∞ –∏ –ñ–∏):*
‚Ä¢ –ú–∞: {random_ma}, –ñ–∏: {random_ji}, –ö—É–Ω: {random_kun}
‚Ä¢ –ö–æ–¥ –¥–∞—Ä–∞ —Å–æ–±—ã—Ç–∏—è: {prediction_data.get('random_gift_code', '')}
"""
        
        if random_gift_info:
            prompt += f"‚Ä¢ –ù–∞–∑–≤–∞–Ω–∏–µ –¥–∞—Ä–∞: {random_gift_info.get('name', '')}\n"
            prompt += f"‚Ä¢ –û–ø–∏—Å–∞–Ω–∏–µ –¥–∞—Ä–∞: {random_gift_info.get('description', '')}\n"
        
        prompt += f"""
–í–ê–ñ–ù–û:
- –ß–µ–ª–æ–≤–µ–∫ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –û–¥–µ (–µ–≥–æ –¥–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è)
- –ö —Å–æ–±—ã—Ç–∏—é "{event_text}" –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è —Å–ª—É—á–∞–π–Ω—ã–µ —ç–Ω–µ—Ä–≥–∏–∏ (–ú–∞ –∏ –ñ–∏)
- –ù—É–∂–Ω–æ –ø–æ–∫–∞–∑–∞—Ç—å –∫–∞–∫ —ç–Ω–µ—Ä–≥–∏—è —Å–æ–±—ã—Ç–∏—è –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤—É–µ—Ç —Å –µ–≥–æ –ª–∏—á–Ω—ã–º –¥–∞—Ä–æ–º –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ —ç—Ç–æ–≥–æ —Å–æ–±—ã—Ç–∏—è

–î–∞–π –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ –≤ —Ñ–æ—Ä–º–∞—Ç–µ:
*–°—É—Ç—å* - –∫—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ —Å–æ–±—ã—Ç–∏—è
*–ß–µ–≥–æ –æ–∂–∏–¥–∞—Ç—å:* –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –æ–∂–∏–¥–∞–Ω–∏—è –æ—Ç —Å–æ–±—ã—Ç–∏—è
*–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:* –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –≤ —Ä–∞–º–∫–∞—Ö —Å–æ–±—ã—Ç–∏—è
*–ù–∞ —á—Ç–æ –æ–±—Ä–∞—Ç–∏—Ç—å –≤–Ω–∏–º–∞–Ω–∏–µ:* –Ω–∞ —á—Ç–æ –æ–±—Ä–∞—Ç–∏—Ç—å –≤–Ω–∏–º–∞–Ω–∏–µ –ø—Ä–∏ —Å–æ–±—ã—Ç–∏–∏

–ë—É–¥—å –ª–∞–∫–æ–Ω–∏—á–Ω—ã–º –∏ —Ç–æ—á–Ω—ã–º. –û—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –∑–∞–ø—Ä–æ—Å–∞ –æ —Å–æ–±—ã—Ç–∏–∏."""
        
        return prompt
    
    def _build_compatibility_prediction_prompt(self, prediction_data: dict) -> str:
        """–ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –ø—Ä–æ–º–ø—Ç–∞ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ –ø–∞—Ä—ã"""
        user_oda = prediction_data.get('user_oda', {})
        partner_oda = prediction_data.get('partner_oda', {})
        user_gift_info = prediction_data.get('user_gift_info', {})
        partner_gift_info = prediction_data.get('partner_gift_info', {})
        
        prompt = f"""–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å –ø–∞—Ä—ã:

*–ü–µ—Ä–≤—ã–π —á–µ–ª–æ–≤–µ–∫ (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å):*
‚Ä¢ –î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è: {prediction_data.get('user_birth_date', '')}
‚Ä¢ –ö–æ–¥ –¥–∞—Ä–∞ –û–¥–∞: {user_oda.get('gift_code', '')}
‚Ä¢ –ú–∞: {user_oda.get('ma', 0)}, –ñ–∏: {user_oda.get('ji', 0)}, –ö—É–Ω: {user_oda.get('kun', 0)}
"""
        
        if user_gift_info:
            prompt += f"‚Ä¢ –ù–∞–∑–≤–∞–Ω–∏–µ –¥–∞—Ä–∞: {user_gift_info.get('name', '')}\n"
            prompt += f"‚Ä¢ –û–ø–∏—Å–∞–Ω–∏–µ –¥–∞—Ä–∞: {user_gift_info.get('description', '')}\n"
        
        prompt += f"""
*–í—Ç–æ—Ä–æ–π —á–µ–ª–æ–≤–µ–∫ (–ø–∞—Ä—Ç–Ω–µ—Ä):*
‚Ä¢ –î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è: {prediction_data.get('partner_birth_date', '')}
‚Ä¢ –ö–æ–¥ –¥–∞—Ä–∞ –û–¥–∞: {partner_oda.get('gift_code', '')}
‚Ä¢ –ú–∞: {partner_oda.get('ma', 0)}, –ñ–∏: {partner_oda.get('ji', 0)}, –ö—É–Ω: {partner_oda.get('kun', 0)}
"""
        
        if partner_gift_info:
            prompt += f"‚Ä¢ –ù–∞–∑–≤–∞–Ω–∏–µ –¥–∞—Ä–∞: {partner_gift_info.get('name', '')}\n"
            prompt += f"‚Ä¢ –û–ø–∏—Å–∞–Ω–∏–µ –¥–∞—Ä–∞: {partner_gift_info.get('description', '')}\n"
        
        prompt += """
–í–ê–ñ–ù–û:
- –ü–µ—Ä–≤—ã–π —á–µ–ª–æ–≤–µ–∫ (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å) –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –û–¥–µ (–µ–≥–æ –¥–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è)
- –ö –Ω–µ–º—É –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —Å –ø–∞—Ä—Ç–Ω–µ—Ä–æ–º (–û–¥–∞ –ø–∞—Ä—Ç–Ω–µ—Ä–∞)
- –ù—É–∂–Ω–æ –ø–æ–∫–∞–∑–∞—Ç—å —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å –æ–¥–Ω–æ–≥–æ —Å –¥—Ä—É–≥–∏–º, –≤–ª–∏—è–Ω–∏–µ –¥—Ä—É–≥ –Ω–∞ –¥—Ä—É–≥–∞
- –û–¥–∞ –Ω–∞ —Ç–æ–º, –∫—Ç–æ –ø–µ—Ä–≤—ã–π –≤–≤–µ–ª —Å–≤–æ—é –¥–∞—Ç—É (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å) - –∫–∞–∫ –Ω–∞ –æ—Å–Ω–æ–≤–Ω–æ–º —á–µ–ª–æ–≤–µ–∫–µ

–î–∞–π –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ –≤ —Ñ–æ—Ä–º–∞—Ç–µ:
*–°—É—Ç—å* - –∫—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
*–ß–µ–≥–æ –æ–∂–∏–¥–∞—Ç—å:* —á—Ç–æ –æ–∂–∏–¥–∞—Ç—å –æ—Ç –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è
*–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:* –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –ø–∞—Ä—ã
*–ù–∞ —á—Ç–æ –æ–±—Ä–∞—Ç–∏—Ç—å –≤–Ω–∏–º–∞–Ω–∏–µ:* –Ω–∞ —á—Ç–æ –æ–±—Ä–∞—Ç–∏—Ç—å –≤–Ω–∏–º–∞–Ω–∏–µ –≤ –æ—Ç–Ω–æ—à–µ–Ω–∏—è—Ö

–ë—É–¥—å –ª–∞–∫–æ–Ω–∏—á–Ω—ã–º –∏ —Ç–æ—á–Ω—ã–º. –û—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ –æ–¥–Ω–æ–≥–æ —Å –¥—Ä—É–≥–∏–º, –Ω–æ —Ñ–æ–∫—É—Å –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ."""
        
        return prompt
    
    def _get_basic_prediction(self, prediction_data: dict) -> str:
        """–ë–∞–∑–æ–≤–∞—è —Ç—Ä–∞–∫—Ç–æ–≤–∫–∞ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è –±–µ–∑ –ò–ò"""
        prediction_type = prediction_data.get('prediction_type', 'day')
        
        result = f"üîÆ *–ü—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ*\n\n"
        
        if prediction_type == 'day':
            day_gift = prediction_data.get('day_gift', {})
            user_oda = prediction_data.get('user_oda', {})
            result += f"üìÖ *–ü—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ –Ω–∞ –¥–µ–Ω—å*\n\n"
            result += f"–í–∞—à –¥–∞—Ä (–û–¥–∞): {user_oda.get('gift_code', '')}\n"
            result += f"–î–∞—Ä –¥–Ω—è: {day_gift.get('gift_code', '')}\n\n"
        elif prediction_type == 'event':
            event = prediction_data.get('event', '')
            result += f"üéØ *–ü—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ –Ω–∞ —Å–æ–±—ã—Ç–∏–µ: {event}*\n\n"
            result += f"–≠–Ω–µ—Ä–≥–∏—è —Å–æ–±—ã—Ç–∏—è: {prediction_data.get('random_gift_code', '')}\n\n"
        elif prediction_type == 'compatibility':
            user_oda = prediction_data.get('user_oda', {})
            partner_oda = prediction_data.get('partner_oda', {})
            result += f"üíë *–°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å –ø–∞—Ä—ã*\n\n"
            result += f"–í–∞—à –¥–∞—Ä: {user_oda.get('gift_code', '')}\n"
            result += f"–î–∞—Ä –ø–∞—Ä—Ç–Ω–µ—Ä–∞: {partner_oda.get('gift_code', '')}\n\n"
        
        result += "‚ö†Ô∏è *API –∫–ª—é—á DeepSeek –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω!*\n"
        result += "üí° _–î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–ª–Ω–æ–≥–æ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è —Å –∞–Ω–∞–ª–∏–∑–æ–º –ò–ò –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É._"
        
        return result

